<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Deja Brew Inventory Management System</title>
    <meta name="description" content="Official Inventory System for Deja Brew Coffee Shop Philippines. Manage stocks, expiry dates, and equipment monitoring. Created by Quita.">
    <meta name="author" content="Quita">
    
    </head>
<title>Deja Brew Inventory Management</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
/* ===== 1. GLOBAL AESTHETICS ===== */
:root {
    --primary: #2b1d1a;      /* Deep Espresso */
    --primary-light: #4e3631; 
    --secondary: #a17a69;    /* Latte */
    --accent: #d4a373;       /* Gold/Caramel */
    --graph-color: #7e57c2;  /* Violet for Graph */
    --bg: #f4f7f6;           /* Desktop Background */
    --card-bg: #ffffff;
    --text: #333;
    --sidebar-width: 260px;
    --danger: #e53935;
    --success: #43a047;
}

* { box-sizing: border-box; }
body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; }

/* UTILITIES */
.btn { border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
.btn:hover { opacity: 0.9; transform: translateY(-1px); }
.btn:active { transform: translateY(0); }
.btn-primary { background: var(--primary); color: var(--accent); }
.btn-accent { background: var(--accent); color: var(--primary); }
.btn-danger { background: var(--danger); color: white; }
.btn-violet { background: var(--graph-color); color: white; }
.btn-small { padding: 5px 10px; font-size: 12px; }

.card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.04); margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.05); }

/* INPUTS */
input, select { border: 1px solid #ddd; padding: 12px; border-radius: 6px; outline: none; transition: 0.3s; width: 100%; font-family: inherit; background: white; }
input:focus, select:focus { border-color: var(--secondary); box-shadow: 0 0 0 3px rgba(161, 122, 105, 0.1); }

/* --- LOGIN SCREEN --- */
#login { display: none; min-height: 100vh; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary) 0%, #1a100e 100%); padding: 20px; }
.login-box { background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 16px; text-align: center; width: 100%; max-width: 420px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
.login-logo { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--accent); margin-bottom: 15px; background: white; object-fit: cover; }

/* --- TOP BAR --- */
.top-nav { height: 70px; background: white; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; position: fixed; top: 0; width: 100%; z-index: 1000; box-shadow: 0 2px 15px rgba(0,0,0,0.04); border-bottom: 1px solid #eee; }
.nav-left { display: flex; align-items: center; font-weight: 700; color: var(--primary); font-size: 18px; letter-spacing: 0.5px; min-width: 250px; }
.nav-center { position: absolute; left: 50%; transform: translateX(-50%); font-weight: 600; color: #888; text-transform: uppercase; font-size: 14px; letter-spacing: 2px; display: none; }
.timer-badge { background: var(--primary); color: var(--accent); padding: 6px 15px; border-radius: 30px; font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: help; }

/* --- SIDEBAR --- */
.sidebar { width: var(--sidebar-width); background: var(--primary); padding: 30px 20px; position: fixed; top: 70px; bottom: 0; left: 0; transform: translateX(-100%); transition: 0.3s; z-index: 999; display: flex; flex-direction: column; box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
.sidebar.active { transform: translateX(0); }
.nav-item { padding: 15px 20px; margin-bottom: 10px; border-radius: 8px; color: rgba(255,255,255,0.6); display: flex; align-items: center; gap: 15px; cursor: pointer; transition: 0.2s; font-weight: 500; }
.nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
.nav-item.active { background: var(--accent); color: var(--primary); font-weight: 700; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

/* --- LAYOUT --- */
.content-area { margin-top: 70px; padding: 30px; transition: 0.3s; min-height: 100vh; }
@media (min-width: 900px) {
    .sidebar { transform: translateX(0); }
    .content-area { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); }
    .menu-trigger { display: none; }
    .nav-center { display: block; }
    .stats-grid { grid-template-columns: repeat(3, 1fr); }
    .split-dashboard { grid-template-columns: 1fr 1fr; }
}

/* --- DASHBOARD --- */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100%, 1fr)); gap: 25px; margin-bottom: 25px; }
.stat-box { background: white; padding: 25px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s; border: 1px solid #eee; position: relative; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
.stat-box:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-color: var(--accent); }
.stat-box h2 { margin: 10px 0; font-size: 42px; color: var(--primary); font-weight: 700; line-height: 1; }
.stat-box span { font-size: 13px; color: #888; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

/* Bar Graph */
.graph-container { display: flex; align-items: flex-end; justify-content: space-around; height: 200px; padding-top: 20px; border-bottom: 1px solid #eee; width: 100%; }
.bar-group { display: flex; flex-direction: column; align-items: center; width: 100%; }
.bar { width: 40px; background: var(--graph-color); border-radius: 6px 6px 0 0; transition: height 1s ease-out; position: relative; opacity: 0.9; }
.bar:hover { opacity: 1; transform: scaleX(1.1); }

/* Lists & Tables */
.split-dashboard { display: grid; gap: 25px; }
.list-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px dashed #eee; font-size: 15px; align-items: center; }
.rank-badge { background: var(--accent); color: var(--primary); width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-right: 10px; }

table { width: 100%; border-collapse: separate; border-spacing: 0; }
th { background: #f8f8f8; color: #666; padding: 15px; text-align: left; font-size: 12px; font-weight: 700; text-transform: uppercase; border-bottom: 2px solid #ddd; }
td { padding: 15px; border-bottom: 1px solid #eee; font-size: 14px; color: #444; }
tr:hover td { background: #fcfcfc; }

/* Modal */
.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; backdrop-filter: blur(4px); justify-content: center; align-items: center; padding: 20px; }
.modal-content { background: white; padding: 30px; border-radius: 16px; width: 100%; max-width: 600px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 25px 50px rgba(0,0,0,0.25); }
.cat-filters { display: flex; gap: 10px; padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px solid #eee; overflow-x: auto; }
.cat-chip { padding: 8px 16px; background: #f4f4f4; border-radius: 30px; font-size: 13px; cursor: pointer; color: #666; transition: 0.2s; white-space: nowrap; }
.cat-chip.active { background: var(--primary); color: var(--accent); }

/* Toast Notification for Errors */
#toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; }
#toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
#toast.error { background-color: var(--danger); }
@keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
@keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
</style>
</head>
<body onclick="resetTimer()" onkeypress="resetTimer()" onmousemove="resetTimer()">

<div id="toast">Message</div>

<section id="splash" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:var(--primary); color:white; cursor:pointer;" onclick="showLogin()">
    <img src="logo.png" style="width:140px; border-radius:50%; border:4px solid var(--accent); margin-bottom:20px; animation:float 3s infinite;" alt="DB Logo" onerror="this.src='https://via.placeholder.com/150/2b1d1a/d4a373?text=DB'">
    <h1 style="font-size:36px; margin:0;">DEJA BREW</h1>
    <p style="color:var(--accent); letter-spacing:3px; font-size:12px; font-weight:bold;">INVENTORY SYSTEM</p>
    <style>@keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }</style>
</section>

<section id="login">
    <div class="login-box">
        <img src="logo.png" class="login-logo" onerror="this.src='https://via.placeholder.com/100?text=Logo'">
        <h2 style="color:var(--primary); margin:0; font-size:28px; font-weight:800; line-height:1.2;">DEJA BREW</h2>
        <p style="color:#888; margin: 5px 0 30px 0; font-size:14px; font-weight:600; letter-spacing:1px; text-transform:uppercase;">Inventory Management</p>
        
        <div style="text-align:left;">
            <select id="role-select" style="margin-bottom:15px; background:#f9f9f9;">
                <option value="" disabled selected>Select Role</option>
                <option value="Admin">Admin (Quita)</option>
                <option value="Manager">Manager (Omlang)</option>
                <option value="Chef">Chef (Briones)</option>
                <option value="Staff">Staff</option>
            </select>
            <input id="user-input" placeholder="Username" autocapitalize="off" style="margin-bottom:15px; background:#f9f9f9;">
            <input id="pass-input" type="password" placeholder="Password" style="background:#f9f9f9;">
        </div>
        
        <button class="btn btn-primary" style="width:100%; margin-top:25px; padding:15px; font-size:14px;" onclick="authenticate()">SECURE LOGIN</button>
    </div>
</section>

<div id="main-app" style="display:none;">
    
    <div class="top-nav">
        <div class="nav-left">
            <i class="material-icons menu-trigger" onclick="toggleSidebar()" style="margin-right:15px; cursor:pointer; color:var(--primary);">menu</i>
            <span id="page-title">DEJA BREW - DASHBOARD</span>
        </div>
        <div class="nav-center">DEJA BREW INVENTORY SYSTEM</div>
        <div class="timer-badge" title="Auto-logout timer">
            <i class="material-icons" style="font-size:16px;">timer</i>
            <span id="timer">5:00</span>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div style="text-align:center; padding-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:20px;">
            <img id="prof-pic" src="" style="width:80px; height:80px; border-radius:50%; border:3px solid var(--accent); object-fit:cover; background:white;" onerror="this.src='https://via.placeholder.com/80'">
            <h3 id="prof-name" style="margin:10px 0 5px 0; color:white;">User</h3>
            <span id="prof-role" style="background:var(--accent); color:var(--primary); padding:4px 12px; border-radius:15px; font-size:11px; font-weight:bold; text-transform:uppercase;">Role</span>
        </div>

        <div class="nav-item active" onclick="nav('dashboard')"><i class="material-icons">dashboard</i> Dashboard</div>
        <div class="nav-item" onclick="nav('inventory')"><i class="material-icons">inventory_2</i> Inventory</div>
        <div class="nav-item" onclick="nav('reports')"><i class="material-icons">analytics</i> Reports</div>
        <div class="nav-item" onclick="nav('history')"><i class="material-icons">history</i> Logs</div>

        <button class="btn" style="background:rgba(255,255,255,0.1); color:white; margin-top:auto; justify-content: flex-start; padding-left:20px;" onclick="logout()">
            <i class="material-icons">logout</i> Sign Out
        </button>
    </div>

    <div class="content-area">
        
        <div id="view-dashboard" class="view-section">
            <div class="stats-grid">
                <div class="stat-box" style="border-bottom: 4px solid var(--secondary);" onclick="openDrillDown('TOTAL')">
                    <h2 id="d-total">0</h2><span>Total Items</span>
                </div>
                <div class="stat-box" style="border-bottom: 4px solid #fbc02d;" onclick="openDrillDown('LOW')">
                    <h2 id="d-low">0</h2><span>Low Stock</span>
                </div>
                <div class="stat-box" style="border-bottom: 4px solid #e53935;" onclick="openDrillDown('EXPIRE')">
                    <h2 id="d-expire">0</h2><span style="color:#e53935;">Expiring Soon</span>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0; color:var(--primary);">Stock Volume by Category</h3>
                </div>
                <div class="graph-container" id="bar-graph"></div>
            </div>

            <div class="split-dashboard">
                <div class="card">
                    <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:15px; color:var(--primary);">
                        <i class="material-icons" style="vertical-align:middle; color:var(--accent);">trending_up</i> Top 5 Most Used
                    </h3>
                    <div id="trend-list"></div>
                </div>
                <div class="card" style="background:#fffcf5; border:1px solid #ffe0b2;">
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #fae0b5; padding-bottom:15px;">
                        <h3 style="margin:0; color:#e65100;"><i class="material-icons" style="vertical-align:middle;">restaurant_menu</i> Menu Highlights</h3>
                        <i id="edit-menu-btn" class="material-icons" style="cursor:pointer; color:#ef6c00; display:none;" onclick="editBestSellers()">edit</i>
                    </div>
                    <div id="menu-best-list" style="font-size:15px; line-height:1.8; color:#bf360c; margin-top:15px; white-space: pre-line;"></div>
                </div>
            </div>
        </div>

        <div id="view-inventory" class="view-section" style="display:none;">
            <div class="card">
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px; align-items:end;">
                    <div><h3 style="margin-top:0;">Stock Management</h3><p style="font-size:13px; color:#666;">Add/Update stock levels.</p></div>
                    <div>
                         <label style="font-size:11px; font-weight:bold; color:var(--primary);">ACTION</label>
                         <select id="stock-action-type" style="background: #f0f4f8; font-weight:bold;" onchange="toggleDateInput()">
                             <option value="IN">➕ STOCK IN (Restock)</option>
                             <option value="OUT">➖ STOCK OUT (Usage)</option>
                         </select>
                    </div>
                </div>
                <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">

                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:15px;">
                    <div>
                        <label style="font-size:11px; color:#888;">Category</label>
                        <div style="display:flex; gap:2px;">
                            <select id="inv-cat"></select>
                            <button onclick="manageCustom('category', 'add')" class="btn btn-primary btn-small" title="Add">+</button>
                            <button onclick="manageCustom('category', 'remove')" class="btn btn-danger btn-small" title="Delete">-</button>
                        </div>
                    </div>
                    <div>
                        <label style="font-size:11px; color:#888;">Item Name</label>
                        <input id="inv-name" placeholder="E.g. Coffee Beans">
                    </div>
                    <div>
                        <label style="font-size:11px; color:#888;">Quantity & Unit</label>
                        <div style="display:flex; gap:2px;">
                            <input id="inv-qty" type="number" placeholder="0">
                            <select id="inv-unit" style="width:90px;"></select>
                            <button onclick="manageCustom('unit', 'add')" class="btn btn-primary btn-small" title="Add">+</button>
                            <button onclick="manageCustom('unit', 'remove')" class="btn btn-danger btn-small" title="Delete">-</button>
                        </div>
                    </div>
                </div>
                
                <div id="expiry-wrapper" style="margin-top:15px;">
                     <label style="font-size:11px; font-weight:bold; color:#d32f2f;">Expiration Date</label>
                     <input id="inv-expiry" type="date">
                </div>

                <button class="btn" style="width:100%; margin-top:20px; background:var(--primary); color:white; padding:15px;" onclick="processStock()">CONFIRM TRANSACTION</button>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0;">Current Inventory</h3>
                    <input id="search-bar" onkeyup="renderInventory()" placeholder="Search..." style="padding:10px; width: 200px;">
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead><tr><th>Item Name</th><th>Category</th><th>Quantity</th><th>Status / Expiry</th><th>Manage</th></tr></thead>
                        <tbody id="inventory-table-body"></tbody>
                    </table>
                </div>
                <div class="pagination" style="display:flex; justify-content:center; gap:15px; margin-top:25px; align-items:center;">
                    <button class="btn btn-primary" onclick="changePage(-1)"><</button>
                    <span id="page-num" style="font-size:13px; font-weight:bold;">Page 1</span>
                    <button class="btn btn-primary" onclick="changePage(1)">></button>
                </div>
            </div>
        </div>

        <div id="view-reports" class="view-section" style="display:none;">
            <div class="card">
                <h3 style="margin-top:0;">Download Reports</h3>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-top:25px;">
                    <button class="btn" style="background:#e3f2fd; color:#1565c0; flex-direction:column; padding:30px; border:1px solid #bbdefb;" onclick="exportReport('LOW')">
                        <i class="material-icons" style="font-size:32px; margin-bottom:10px;">warning</i> Low Stock
                    </button>
                    <button class="btn" style="background:#e8f5e9; color:#2e7d32; flex-direction:column; padding:30px; border:1px solid #c8e6c9;" onclick="exportReport('NEEDS')">
                        <i class="material-icons" style="font-size:32px; margin-bottom:10px;">shopping_cart</i> Purchase Plan
                    </button>
                    <button class="btn" style="background:#fff3e0; color:#ef6c00; flex-direction:column; padding:30px; border:1px solid #ffe0b2;" onclick="exportReport('LOGS')">
                        <i class="material-icons" style="font-size:32px; margin-bottom:10px;">list_alt</i> Logs
                    </button>
                    <button class="btn" style="background:#ffebee; color:#c62828; flex-direction:column; padding:30px; border:1px solid #ffcdd2;" onclick="exportReport('EXPIRED')">
                        <i class="material-icons" style="font-size:32px; margin-bottom:10px;">event_busy</i> Expired Items
                    </button>
                </div>
            </div>
        </div>

        <div id="view-history" class="view-section" style="display:none;">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Audit Trail Log</h3>
                    <button id="clear-logs-btn" class="btn btn-danger" style="font-size:12px; display:none;" onclick="clearLogs()">CLEAR HISTORY</button>
                </div>
                <div style="overflow-x:auto; margin-top:15px;">
                    <table style="font-size:13px;">
                        <thead><tr><th>Timestamp</th><th>User</th><th>Action</th><th>Item Details</th></tr></thead>
                        <tbody id="log-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="drill-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="drill-title" style="margin-top:0; color:var(--primary); border-bottom:1px solid #eee; padding-bottom:15px;">Details</h3>
        <div id="cat-filters" class="cat-filters"></div>
        <div id="drill-list-container" class="drill-list" style="overflow-y:auto; flex:1; margin-bottom:15px;"></div>
        <div class="pagination" style="display:flex; justify-content:space-between; align-items:center; border-top:1px solid #eee; padding-top:15px;">
             <button class="btn btn-primary" onclick="changeDrillPage(-1)"><</button>
             <span id="drill-page-num" style="font-size:12px;">Page 1</span>
             <button class="btn btn-primary" onclick="changeDrillPage(1)">></button>
        </div>
        <button class="btn" style="width:100%; margin-top:15px; background:#ddd; color:#444;" onclick="document.getElementById('drill-modal').style.display='none'">Close</button>
    </div>
</div>

<script>
/* --- CONFIG & DATA --- */
const accounts = {
    "quita": { pass: "Quita246", role: "Admin", name: "Quita", pic: "admin.png" },
    "omlang": { pass: "Omlang246", role: "Manager", name: "Omlang", pic: "manager.png" },
    "briones": { pass: "Briones246", role: "Chef", name: "Briones", pic: "chef.png" },
    "decastro": { pass: "Staff246", role: "Staff", name: "Decastro", pic: "decastro.png" },
    "ewayan": { pass: "Staff246", role: "Staff", name: "Ewayan", pic: "ewayan.png" },
    "tan": { pass: "Staff246", role: "Staff", name: "Tan", pic: "tan.png" }
};

// Error handling for Storage
let db, logs, categories, units, menuBestSellers;
try {
    db = JSON.parse(localStorage.getItem("db_inventory")) || {};
    logs = JSON.parse(localStorage.getItem("db_logs")) || [];
    categories = JSON.parse(localStorage.getItem("db_cats")) || ["Ingredients", "Machines", "Packaging", "Utensils"];
    units = JSON.parse(localStorage.getItem("db_units")) || ["kg", "pcs", "packs", "liters", "cans"];
    menuBestSellers = localStorage.getItem("db_menu_best") || "1. Caramel Macchiato\n2. Croissant\n3. Iced Americano";
} catch(e) {
    showToast("Storage Error: Data reset.", "error");
    db={}; logs=[]; categories=["Ingredients"]; units=["pcs"];
}

let currentUser = null;
let currentPage = 1;
const itemsPerPage = 8;
let sessionTimer;
let timeLeft = 300; // 5 mins

// Drill Down State
let drillAllItems = [];
let currentDrillCat = "All";
let drillPage = 1;
const drillPerPage = 6;

/* --- INIT --- */
document.addEventListener("DOMContentLoaded", () => {
    setTimeout(() => {
        document.getElementById("splash").style.display = "none";
        document.getElementById("login").style.display = "flex";
    }, 2000); 
    populateSelects();
    toggleDateInput();
});

/* --- UTILS --- */
function showToast(msg, type='info') {
    const t = document.getElementById("toast");
    t.innerText = msg;
    t.className = type === 'error' ? 'show error' : 'show';
    setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
}

function populateSelects() {
    const catSel = document.getElementById("inv-cat");
    const unitSel = document.getElementById("inv-unit");
    catSel.innerHTML = categories.map(c => `<option>${c}</option>`).join('');
    unitSel.innerHTML = units.map(u => `<option>${u}</option>`).join('');
}

/* --- AUTH & SESSION --- */
function authenticate() {
    try {
        const role = document.getElementById("role-select").value;
        const u = document.getElementById("user-input").value.trim().toLowerCase();
        const p = document.getElementById("pass-input").value;

        if (accounts[u] && accounts[u].pass === p && accounts[u].role === role) {
            currentUser = accounts[u];
            document.getElementById("login").style.display = "none";
            document.getElementById("main-app").style.display = "flex"; 
            
            document.getElementById("prof-name").innerText = currentUser.name;
            document.getElementById("prof-role").innerText = currentUser.role;
            document.getElementById("prof-pic").src = currentUser.pic;
            
            if(currentUser.role === 'Admin' || currentUser.role === 'Manager') {
                document.getElementById("edit-menu-btn").style.display = "inline-block";
            }
            if(currentUser.role === 'Admin') document.getElementById("clear-logs-btn").style.display = "block";
            
            startSession();
            nav('dashboard');
        } else {
            showToast("Invalid Login Details", "error");
        }
    } catch(e) { showToast("Login Error", "error"); }
}

function logout() { location.reload(); }

function startSession() {
    clearInterval(sessionTimer);
    timeLeft = 300; 
    const timerDisplay = document.getElementById("timer");
    sessionTimer = setInterval(() => {
        timeLeft--;
        let m = Math.floor(timeLeft / 60);
        let s = timeLeft % 60;
        timerDisplay.innerText = `${m}:${s < 10 ? '0'+s : s}`;
        if(timeLeft <= 0) logout();
    }, 1000);
}

// RESET TIMER ON ACTIVITY
function resetTimer() { timeLeft = 300; }

/* --- NAVIGATION --- */
function nav(viewId) {
    try {
        document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${viewId}`).style.display = 'block';
        
        const titles = {
            'dashboard': 'DEJA BREW - DASHBOARD',
            'inventory': 'DEJA BREW - INVENTORY',
            'reports': 'DEJA BREW - REPORTS',
            'history': 'DEJA BREW - LOGS'
        };
        document.getElementById("page-title").innerText = titles[viewId] || "DEJA BREW";

        const navItems = document.querySelectorAll('.nav-item');
        if(viewId === 'dashboard') { navItems[0].classList.add('active'); renderDashboard(); }
        if(viewId === 'inventory') { navItems[1].classList.add('active'); renderInventory(); }
        if(viewId === 'reports') navItems[2].classList.add('active');
        if(viewId === 'history') { navItems[3].classList.add('active'); renderLogs(); }

        if(window.innerWidth < 900) toggleSidebar();
    } catch(e) { console.error("Nav error", e); }
}

function toggleSidebar() { document.getElementById("sidebar").classList.toggle("active"); }

/* --- INVENTORY LOGIC --- */
function manageCustom(type, action) {
    try {
        if(action === 'add') {
            const val = prompt(`Enter new ${type}:`);
            if(val && val.trim() !== "") {
                if(type === 'category') { 
                    if(!categories.includes(val)) categories.push(val); 
                    localStorage.setItem("db_cats", JSON.stringify(categories)); 
                }
                if(type === 'unit') { 
                    if(!units.includes(val)) units.push(val); 
                    localStorage.setItem("db_units", JSON.stringify(units)); 
                }
                populateSelects();
                showToast(`${type} added`);
            }
        } else if (action === 'remove') {
            const current = document.getElementById(type === 'category' ? "inv-cat" : "inv-unit").value;
            if(confirm(`Are you sure you want to delete the ${type} "${current}"?`)) {
                if(type === 'category') {
                    categories = categories.filter(c => c !== current);
                    if(categories.length === 0) categories.push("General");
                    localStorage.setItem("db_cats", JSON.stringify(categories));
                }
                if(type === 'unit') {
                    units = units.filter(u => u !== current);
                    if(units.length === 0) units.push("pcs");
                    localStorage.setItem("db_units", JSON.stringify(units));
                }
                populateSelects();
                showToast(`${type} removed`);
            }
        }
    } catch(e) { showToast("Error managing options", "error"); }
}

function toggleDateInput() {
    const type = document.getElementById("stock-action-type").value;
    document.getElementById("expiry-wrapper").style.display = (type === 'IN') ? 'block' : 'none';
}

function processStock() {
    try {
        const type = document.getElementById("stock-action-type").value; 
        const name = document.getElementById("inv-name").value.trim().toUpperCase();
        const qtyVal = document.getElementById("inv-qty").value;
        const qty = parseFloat(qtyVal);
        const cat = document.getElementById("inv-cat").value;
        const unit = document.getElementById("inv-unit").value;
        const expiry = document.getElementById("inv-expiry").value;

        if(!name) return showToast("Please enter an item name", "error");
        if(isNaN(qty) || qty <= 0) return showToast("Invalid Quantity", "error");

        if(!db[name]) {
            db[name] = { qty: 0, cat: cat, unit: unit, expiry: '', lastUpdated: Date.now(), stockOutCount: 0 };
        }

        if(type === 'IN') {
            db[name].qty += qty;
            db[name].cat = cat; 
            db[name].unit = unit;
            if(expiry) db[name].expiry = expiry; 
            db[name].lastUpdated = Date.now();
        } else {
            if(db[name].qty < qty) return showToast("Insufficient Stock!", "error");
            db[name].qty -= qty;
            db[name].stockOutCount += qty;
        }

        localStorage.setItem("db_inventory", JSON.stringify(db));
        logTx(type, name, qty);
        
        document.getElementById("inv-name").value = "";
        document.getElementById("inv-qty").value = "";
        document.getElementById("inv-expiry").value = "";
        renderInventory();
        showToast("Transaction Successful!", "success");
    } catch(e) { showToast("Transaction Failed", "error"); console.error(e); }
}

function deleteItem(name) {
    if(confirm("Delete item permanently?")) {
        delete db[name];
        localStorage.setItem("db_inventory", JSON.stringify(db));
        renderInventory();
    }
}

/* --- RENDER INVENTORY --- */
function renderInventory() {
    const tbody = document.getElementById("inventory-table-body");
    tbody.innerHTML = "";
    const search = document.getElementById("search-bar").value.toLowerCase();

    let list = Object.entries(db).map(([k, v]) => ({name: k, ...v}));
    list.sort((a,b) => b.lastUpdated - a.lastUpdated); 
    list = list.filter(item => item.name.toLowerCase().includes(search) || item.cat.toLowerCase().includes(search));

    const totalPages = Math.ceil(list.length / itemsPerPage) || 1;
    if(currentPage > totalPages) currentPage = totalPages;
    const start = (currentPage - 1) * itemsPerPage;
    const pageItems = list.slice(start, start + itemsPerPage);

    document.getElementById("page-num").innerText = `Page ${currentPage} of ${totalPages}`;

    pageItems.forEach(item => {
        let expInfo = item.expiry ? `<span style="color:${new Date(item.expiry) < new Date() ? 'red' : '#333'}; font-weight:bold;">${item.expiry}</span>` : '<span style="color:#aaa;">-</span>';
        tbody.innerHTML += `
        <tr>
            <td><b>${item.name}</b></td>
            <td><span style="background:#f0f0f0; padding:4px 10px; border-radius:12px; font-size:11px;">${item.cat}</span></td>
            <td style="color:${item.qty<=5?'var(--danger)':'inherit'}; font-weight:bold;">${item.qty} ${item.unit}</td>
            <td>${expInfo}</td>
            <td>${currentUser.role === 'Admin' ? `<button onclick="deleteItem('${item.name}')" style="background:none; border:none; color:#888; cursor:pointer;"><i class="material-icons">delete</i></button>` : ''}</td>
        </tr>`;
    });
}
function changePage(dir) {
    if(dir === 1) currentPage++;
    else if (currentPage > 1) currentPage--;
    renderInventory();
}

/* --- DASHBOARD --- */
function renderDashboard() {
    let totalItems = 0, lowStock = 0, expiring = 0;
    let trendArr = [];
    let catCounts = {}; 
    const today = new Date();

    Object.entries(db).forEach(([name, item]) => {
        totalItems++;
        if(item.qty <= 5) lowStock++;
        if(item.expiry) {
            const diff = (new Date(item.expiry) - today) / (1000*60*60*24);
            if(diff <= 7 && diff >= -30) expiring++; // Upcoming or recently expired
        }
        if(item.stockOutCount > 0) trendArr.push({name: name, count: item.stockOutCount});
        
        if(!catCounts[item.cat]) catCounts[item.cat] = 0;
        catCounts[item.cat] += item.qty;
    });

    document.getElementById("d-total").innerText = totalItems;
    document.getElementById("d-low").innerText = lowStock;
    document.getElementById("d-expire").innerText = expiring;

    trendArr.sort((a,b) => b.count - a.count);
    const trendList = document.getElementById("trend-list");
    trendList.innerHTML = "";
    if(trendArr.length === 0) trendList.innerHTML = "<small>No data yet.</small>";
    
    trendArr.slice(0, 5).forEach((t, i) => {
        trendList.innerHTML += `<div class="list-item"><span><span class="rank-badge">${i+1}</span> ${t.name}</span> <b>${t.count} used</b></div>`;
    });

    document.getElementById("menu-best-list").innerText = menuBestSellers;
    renderGraph(catCounts);
}

function renderGraph(data) {
    const container = document.getElementById("bar-graph");
    container.innerHTML = "";
    const keys = Object.keys(data);
    if(keys.length === 0) { container.innerHTML = "<small>No data.</small>"; return; }
    const maxVal = Math.max(...Object.values(data));

    keys.forEach(cat => {
        const val = data[cat];
        const height = maxVal > 0 ? (val / maxVal) * 100 : 0;
        const finalHeight = height < 15 ? 15 : height; 
        container.innerHTML += `
        <div class="bar-group">
             <div style="font-size:10px; font-weight:bold; margin-bottom:5px;">${val}</div>
             <div class="bar" style="height:${finalHeight}px;" title="${cat}: ${val}"></div>
             <div style="font-size:10px; color:#666; margin-top:5px;">${cat.substring(0,6)}..</div>
        </div>`;
    });
}

function editBestSellers() {
    const input = prompt("Enter Menu Highlights:", menuBestSellers);
    if(input !== null) {
        menuBestSellers = input;
        localStorage.setItem("db_menu_best", menuBestSellers);
        renderDashboard();
    }
}

/* --- DRILL DOWN --- */
function openDrillDown(type) {
    const today = new Date();
    drillAllItems = []; 
    drillPage = 1;
    currentDrillCat = "All";
    document.getElementById("drill-modal").style.display = "flex";
    
    let title = "";
    Object.entries(db).forEach(([name, item]) => {
        let include = false;
        let extraInfo = `${item.qty} ${item.unit}`;
        if(type === 'TOTAL') { title = "Total Inventory"; include = true; }
        else if (type === 'LOW') { 
            title = "Low Stock Alerts"; 
            if(item.qty <= 5) { include = true; extraInfo = `<span style="color:red; font-weight:bold;">${item.qty} ${item.unit}</span>`; }
        }
        else if (type === 'EXPIRE') {
            title = "Expiring / Expired";
            if(item.expiry) {
                const diff = (new Date(item.expiry) - today) / (1000*60*60*24);
                if(diff <= 7) { include = true; extraInfo = `Exp: ${item.expiry}`; }
            }
        }
        if(include) drillAllItems.push({ name: name, cat: item.cat, info: extraInfo });
    });
    document.getElementById("drill-title").innerText = title;
    renderCategoryFilters();
    renderDrillDownList();
}
function renderCategoryFilters() {
    const filterContainer = document.getElementById("cat-filters");
    let availableCats = ["All", ...categories];
    filterContainer.innerHTML = availableCats.map(cat => `<div class="cat-chip ${cat === currentDrillCat ? 'active' : ''}" onclick="filterDrillCat('${cat}')">${cat}</div>`).join('');
}
function filterDrillCat(cat) { currentDrillCat = cat; drillPage = 1; renderCategoryFilters(); renderDrillDownList(); }
function renderDrillDownList() {
    const container = document.getElementById("drill-list-container");
    container.innerHTML = "";
    let filtered = (currentDrillCat === "All") ? drillAllItems : drillAllItems.filter(i => i.cat === currentDrillCat);
    filtered.sort((a,b) => a.name.localeCompare(b.name));
    if(filtered.length === 0) { container.innerHTML = `<div style="padding:20px; text-align:center; color:#999;">No items found.</div>`; document.getElementById("drill-page-num").innerText = "-"; return; }
    const totalPages = Math.ceil(filtered.length / drillPerPage) || 1;
    if(drillPage > totalPages) drillPage = totalPages;
    const start = (drillPage - 1) * drillPerPage;
    const itemsToShow = filtered.slice(start, start + drillPerPage);
    document.getElementById("drill-page-num").innerText = `Page ${drillPage}/${totalPages}`;
    itemsToShow.forEach(item => {
        container.innerHTML += `<div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #f0f0f0; font-size:14px;"><span><b>${item.name}</b> <span style="color:#999; font-size:12px;">(${item.cat})</span></span><span>${item.info}</span></div>`;
    });
}
function changeDrillPage(dir) {
    let filteredLen = (currentDrillCat === "All") ? drillAllItems.length : drillAllItems.filter(i => i.cat === currentDrillCat).length;
    const totalPages = Math.ceil(filteredLen / drillPerPage) || 1;
    if(dir === 1 && drillPage < totalPages) drillPage++;
    else if (dir === -1 && drillPage > 1) drillPage--;
    renderDrillDownList();
}

/* --- LOGS & REPORTS --- */
function logTx(action, item, qty) {
    logs.unshift({ date: new Date().toLocaleString(), user: currentUser.name, action: action, item: item, qty: qty });
    if(logs.length > 150) logs.pop();
    localStorage.setItem("db_logs", JSON.stringify(logs));
}
function renderLogs() {
    document.getElementById("log-table-body").innerHTML = logs.map(l => `<tr><td>${l.date}</td><td>${l.user}</td><td style="color:${l.action==='IN'?'green':'red'}">${l.action}</td><td>${l.item} (${l.qty})</td></tr>`).join('');
}
function clearLogs() { if(confirm("Clear Audit Trail?")) { logs = []; localStorage.setItem("db_logs", JSON.stringify(logs)); renderLogs(); } }

function exportReport(type) {
    try {
        let csv = "data:text/csv;charset=utf-8,";
        if(type === 'LOW') { 
            csv += "Category,Item,Qty,Unit\n"; 
            Object.entries(db).forEach(([k,v]) => { if(v.qty<=5) csv += `${v.cat},${k},${v.qty},${v.unit}\n`; }); 
        }
        else if (type === 'NEEDS') { 
            csv += "Item,Sold,Estimated Need\n"; 
            Object.entries(db).forEach(([k,v]) => { csv += `${k},${v.stockOutCount},${v.stockOutCount}\n`; }); 
        }
        else if (type === 'LOGS') { 
            csv += "Date,User,Action,Item,Qty\n"; 
            logs.forEach(l => csv += `${l.date},${l.user},${l.action},${l.item},${l.qty}\n`); 
        }
        else if (type === 'EXPIRED') {
            csv += "Category,Item,Qty,Expiry Date,Status\n";
            const today = new Date();
            Object.entries(db).forEach(([k,v]) => {
                if(v.expiry) {
                    const expDate = new Date(v.expiry);
                    if(expDate < today) csv += `${v.cat},${k},${v.qty},${v.expiry},EXPIRED\n`;
                }
            });
        }
        const link = document.createElement("a"); link.href = encodeURI(csv); link.download = `report_${type.toLowerCase()}.csv`; link.click();
        showToast("Report Downloaded", "success");
    } catch(e) { showToast("Export Failed", "error"); }
}
</script>
</body>
</html>