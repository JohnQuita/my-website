<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Deja Brew Inventory Management</title>
    <meta name="description" content="Official Inventory System for Deja Brew Coffee Shop Philippines.">
    <meta name="author" content="Quita">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
/* ===== 1. GLOBAL AESTHETICS (RESTORED) ===== */
:root {
    --primary: #2b1d1a;      /* Deep Espresso */
    --primary-light: #4e3631; 
    --secondary: #a17a69;    /* Latte */
    --accent: #d4a373;       /* Gold/Caramel */
    --highlight: #ffd54f;    /* Bright Yellow for Login Accent */
    --graph-color: #7e57c2;  
    --bg: #f4f7f6;           
    --card-bg: #ffffff;
    --text: #333;
    --sidebar-width: 260px;
    --danger: #e53935;
    --success: #43a047;
    --warning: #fbc02d;
}

/* Dark Theme Variables (Toggleable) */
[data-theme="dark"] {
    --primary: #1e1e1e;
    --primary-light: #2d2d2d;
    --secondary: #d4a373;
    --accent: #ffd54f;
    --bg: #121212;
    --card-bg: #1e1e1e;
    --text: #e0e0e0;
    --sidebar-width: 260px;
    --danger: #ef5350;
    --success: #66bb6a;
}

* { box-sizing: border-box; }
body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; transition: background 0.3s, color 0.3s; }

/* UTILITIES */
.btn { border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
.btn:hover { opacity: 0.9; transform: translateY(-1px); }
.btn:active { transform: translateY(0); }
.btn-primary { background: var(--primary); color: var(--accent); }
.btn-accent { background: var(--accent); color: var(--primary); }
.btn-danger { background: var(--danger); color: white; }
.btn-success { background: var(--success); color: white; }
.btn-login { background: var(--highlight); color: black; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; border: 2px solid var(--highlight); }
.btn-login:hover { background: transparent; color: var(--highlight); box-shadow: 0 0 15px rgba(255, 213, 79, 0.4); }
.btn-small { padding: 5px 10px; font-size: 12px; }

.card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.04); margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.05); }

/* INPUTS */
input, select { border: 1px solid #ddd; padding: 12px; border-radius: 6px; outline: none; transition: 0.3s; width: 100%; font-family: inherit; background: var(--card-bg); color: var(--text); }
input:focus, select:focus { border-color: var(--secondary); box-shadow: 0 0 0 3px rgba(161, 122, 105, 0.1); }

/* --- LOGIN SCREEN (CYBER/DARK SPLIT DESIGN) --- */
#login { 
    display: none; 
    min-height: 100vh; 
    background: #121212; 
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}
.login-container { display: flex; width: 100%; max-width: 1200px; height: 100vh; box-shadow: 0 0 50px rgba(0,0,0,0.5); overflow: hidden; }
.login-left {
    flex: 1; background: linear-gradient(135deg, #1a100e 0%, #2b1d1a 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; padding: 40px; text-align: center;
}
.login-mascot { width: 250px; height: 250px; object-fit: cover; border-radius: 50%; border: 6px solid var(--highlight); box-shadow: 0 0 30px rgba(255, 213, 79, 0.2); margin-bottom: 20px; animation: float 4s ease-in-out infinite; }
.login-left h1 { color: white; font-size: 48px; margin: 0; font-weight: 800; letter-spacing: -2px; }
.login-left p { color: var(--accent); letter-spacing: 4px; font-weight: bold; margin-top: 10px; text-transform: uppercase; }
.login-right { flex: 0.8; background: #1e1e1e; display: flex; flex-direction: column; justify-content: center; padding: 60px; border-left: 1px solid #333; position: relative; }
.login-right::before { content: ''; position: absolute; top: 0; right: 0; width: 150px; height: 150px; border-top: 4px solid var(--highlight); border-right: 4px solid var(--highlight); border-radius: 0 20px 0 0; }
.login-header { margin-bottom: 40px; }
.login-header h2 { color: white; font-size: 32px; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 2px; }
.login-header span { color: var(--highlight); font-weight: bold; letter-spacing: 1px; font-size: 14px; text-transform: uppercase; }
.cyber-input-group { margin-bottom: 25px; }
.cyber-input-group label { display: block; color: #888; font-size: 11px; font-weight: bold; margin-bottom: 8px; letter-spacing: 1px; text-transform: uppercase; }
.cyber-input { background: transparent; border: 1px solid #444; color: white; border-radius: 4px; font-family: 'Poppins', sans-serif; }
.cyber-input:focus { border-color: var(--highlight); box-shadow: 0 0 10px rgba(255, 213, 79, 0.1); }
.cyber-select { background: #1e1e1e; color: white; border-color: #444; }
.login-options { display: flex; justify-content: space-between; margin-top: 20px; font-size: 12px; }
.login-options a { color: #888; text-decoration: none; transition: 0.3s; cursor: pointer; }
.login-options a:hover { color: var(--highlight); }

@media (max-width: 900px) {
    .login-container { flex-direction: column; }
    .login-left { padding: 30px; flex: 0.4; min-height: 250px; }
    .login-mascot { width: 120px; height: 120px; border-width: 3px; }
    .login-left h1 { font-size: 32px; }
    .login-right { padding: 30px; flex: 1; border-left: none; border-top: 4px solid var(--highlight); }
    .login-right::before { display: none; }
}

/* --- MAIN LAYOUT --- */
.top-nav { height: 70px; background: var(--card-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; position: fixed; top: 0; width: 100%; z-index: 1000; box-shadow: 0 2px 15px rgba(0,0,0,0.04); border-bottom: 1px solid #eee; }
.nav-left { display: flex; align-items: center; font-weight: 700; color: var(--primary); font-size: 16px; min-width: 200px; }
.nav-center { position: absolute; left: 50%; transform: translateX(-50%); font-weight: 600; color: #888; text-transform: uppercase; font-size: 14px; letter-spacing: 2px; display: none; }
.nav-right { display: flex; align-items: center; gap: 15px; }

.timer-badge { background: var(--primary); color: var(--accent); padding: 6px 12px; border-radius: 30px; font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

/* Notifications */
.notif-wrapper { position: relative; cursor: pointer; margin-right: 10px; }
.notif-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; font-size: 10px; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-weight: bold; display: none; }
.notif-dropdown { display: none; position: absolute; right: 0; top: 35px; width: 280px; background: var(--card-bg); border: 1px solid #eee; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border-radius: 8px; z-index: 2000; max-height: 300px; overflow-y: auto; }
.notif-item { padding: 12px; border-bottom: 1px solid #eee; font-size: 12px; display: flex; align-items: center; gap: 10px; color: var(--text); }
.notif-item:hover { background: rgba(0,0,0,0.03); }
.notif-warning { border-left: 3px solid var(--warning); }
.notif-danger { border-left: 3px solid var(--danger); }

/* Sidebar */
.sidebar { width: var(--sidebar-width); background: var(--primary); padding: 30px 20px; position: fixed; top: 70px; bottom: 0; left: 0; transform: translateX(-100%); transition: 0.3s; z-index: 999; display: flex; flex-direction: column; box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
.sidebar.active { transform: translateX(0); }
.nav-item { padding: 15px 20px; margin-bottom: 10px; border-radius: 8px; color: rgba(255,255,255,0.6); display: flex; align-items: center; gap: 15px; cursor: pointer; transition: 0.2s; font-weight: 500; }
.nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
.nav-item.active { background: var(--accent); color: var(--primary); font-weight: 700; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

.content-area { margin-top: 70px; padding: 20px; transition: 0.3s; min-height: 100vh; width: 100%; }
@media (min-width: 900px) {
    .sidebar { transform: translateX(0); }
    .content-area { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); padding: 30px; }
    .menu-trigger { display: none; }
    .nav-center { display: block; }
    .stats-grid { grid-template-columns: repeat(3, 1fr); }
    .split-dashboard { grid-template-columns: 1fr 1fr; }
}

/* --- COMPONENTS --- */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100%, 1fr)); gap: 20px; margin-bottom: 25px; }
.stat-box { background: var(--card-bg); padding: 25px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s; border: 1px solid #eee; position: relative; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
.stat-box:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-color: var(--accent); }
.stat-box h2 { margin: 10px 0; font-size: 36px; color: var(--primary); font-weight: 700; line-height: 1; }
.stat-box span { font-size: 12px; color: #888; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

/* Modals */
.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; backdrop-filter: blur(5px); justify-content: center; align-items: center; padding: 20px; }
.modal-content { background: var(--card-bg); padding: 30px; border-radius: 16px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border-top: 5px solid var(--primary); color: var(--text); }
.modal-title { margin: 0 0 20px 0; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 15px; }

/* Custom Form Styles for Modals */
.form-group { margin-bottom: 15px; }
.form-group label { display: block; font-size: 12px; font-weight: bold; color: #666; margin-bottom: 5px; }
.form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; background: var(--card-bg); color: var(--text); }
.file-upload-wrapper { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; margin-bottom: 15px; }
.file-upload-wrapper:hover { border-color: var(--accent); background: #fafafa; }

/* Toast */
#toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; }
#toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
#toast.error { background-color: var(--danger); }
#toast.success { background-color: var(--success); }
@keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
@keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
@keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-15px);} }

/* Graph & Tables */
.graph-container { display: flex; align-items: flex-end; justify-content: space-around; height: 200px; padding-top: 20px; border-bottom: 1px solid #eee; width: 100%; }
.bar-group { display: flex; flex-direction: column; align-items: center; width: 100%; }
.bar { width: 30px; background: var(--graph-color); border-radius: 6px 6px 0 0; transition: height 1s ease-out; position: relative; opacity: 0.9; }
table { width: 100%; border-collapse: separate; border-spacing: 0; }
th { background: #f8f8f8; color: #666; padding: 15px; text-align: left; font-size: 11px; font-weight: 700; text-transform: uppercase; border-bottom: 2px solid #ddd; }
td { padding: 15px; border-bottom: 1px solid #eee; font-size: 13px; color: #444; }
.cat-filters { display: flex; gap: 10px; padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px solid #eee; overflow-x: auto; }
.cat-chip { padding: 8px 16px; background: #f4f4f4; border-radius: 30px; font-size: 12px; cursor: pointer; color: #666; transition: 0.2s; white-space: nowrap; }
.cat-chip.active { background: var(--primary); color: var(--accent); }

/* PRINT STYLES */
@media print {
    body { background: white; color: black; }
    .sidebar, .top-nav, .btn, .pagination, .no-print, #stock-action-type, #expiry-wrapper { display: none !important; }
    .content-area { margin: 0; padding: 0; width: 100%; }
    .card { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; }
    table { width: 100%; border: 1px solid #ccc; }
    th, td { border: 1px solid #ccc; padding: 5px; color: black; }
    #view-reports { display: block !important; }
}
</style>
</head>
<body onclick="resetTimer()" onkeypress="resetTimer()" onmousemove="resetTimer()">

<div id="toast">Message</div>

<section id="splash" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:var(--primary); color:white; cursor:pointer;" onclick="showLogin()">
    <img src="logo.png" style="width:140px; border-radius:50%; border:4px solid var(--accent); margin-bottom:20px; animation:float 3s infinite;" alt="DB Logo" onerror="this.src='https://via.placeholder.com/150/2b1d1a/d4a373?text=DB'">
    <h1 style="font-size:36px; margin:0;">DEJA BREW</h1>
    <p style="color:var(--accent); letter-spacing:3px; font-size:12px; font-weight:bold;">INVENTORY SYSTEM</p>
</section>

<section id="login">
    <div class="login-container">
        <div class="login-left">
            <img src="logo.png" class="login-mascot" onerror="this.src='https://via.placeholder.com/250/2b1d1a/d4a373?text=DB'">
            <h1>DEJA BREW</h1>
            <p>Inventory Management</p>
        </div>
        
        <div class="login-right">
            <div class="login-header">
                <span>Welcome</span>
                <h2>Sign in</h2>
                <div style="height:3px; width:60px; background:var(--highlight);"></div>
            </div>

            <div class="cyber-input-group">
                <label>Operative Role</label>
                <select id="role-select" class="cyber-select input-lg" style="width:100%; padding:12px;">
                    <option value="" disabled selected>SELECT ROLE LEVEL</option>
                    <option value="Admin">Admin</option>
                    <option value="Manager">Manager</option>
                    <option value="Chef">Chef</option>
                    <option value="Staff">Staff</option>
                </select>
            </div>

            <div class="cyber-input-group">
                <label>Username / Email</label>
                <input id="user-input" class="cyber-input" placeholder="Enter username" autocapitalize="off" style="width:100%;">
            </div>

            <div class="cyber-input-group">
                <label>Password</label>
                <input id="pass-input" type="password" class="cyber-input" placeholder="••••••••" style="width:100%;">
            </div>
            
            <button class="btn btn-login" style="width:100%; padding:18px;" onclick="authenticate()">Sign in</button>

            <div class="login-options">
                <a onclick="openRegisterModal()">No existing account? Register</a>
                <a onclick="forgotPass()">Forgot password?</a>
            </div>
        </div>
    </div>
</section>

<div id="main-app" style="display:none;">
    <div class="top-nav">
        <div class="nav-left">
            <i class="material-icons menu-trigger" onclick="toggleSidebar()" style="margin-right:15px; cursor:pointer; color:var(--primary);">menu</i>
            <span id="page-title">DEJA BREW INVENTORY MANAGEMENT</span>
        </div>
        <div class="nav-center">DEJA BREW INVENTORY MANAGEMENT</div>
        <div class="nav-right" style="display:flex; align-items:center; gap:15px;">
            <div class="notif-wrapper" onclick="toggleNotif()">
                <i class="material-icons" style="color:var(--primary);">notifications</i>
                <div id="notif-count" class="notif-badge">0</div>
                <div id="notif-dropdown" class="notif-dropdown"></div>
            </div>
            <div class="timer-badge" title="Auto-logout timer">
                <i class="material-icons" style="font-size:16px;">timer</i>
                <span id="timer">5:00</span>
            </div>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div style="text-align:center; padding-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:20px;">
            <img id="prof-pic" src="" style="width:80px; height:80px; border-radius:50%; border:3px solid var(--accent); object-fit:cover; background:white;" onerror="this.src='https://via.placeholder.com/80'">
            <h3 id="prof-name" style="margin:10px 0 5px 0; color:white;">User</h3>
            <span id="prof-role" style="background:var(--accent); color:var(--primary); padding:4px 12px; border-radius:15px; font-size:11px; font-weight:bold; text-transform:uppercase;">Role</span>
            <div style="margin-top:10px;">
                <button class="btn btn-small" style="background:rgba(255,255,255,0.2); color:white; font-size:11px;" onclick="openProfileModal()">Edit Profile</button>
            </div>
        </div>

        <div class="nav-item active" onclick="nav('dashboard')"><i class="material-icons">dashboard</i> Dashboard</div>
        <div class="nav-item" onclick="nav('inventory')"><i class="material-icons">inventory_2</i> Inventory</div>
        <div class="nav-item" onclick="nav('reports')"><i class="material-icons">analytics</i> Reports</div>
        <div class="nav-item" onclick="nav('history')"><i class="material-icons">history</i> Logs</div>
        
        <div id="admin-user-nav" class="nav-item" onclick="nav('users')" style="display:none;"><i class="material-icons">people</i> Users</div>

        <div style="margin-top:auto;">
            <div class="nav-item" onclick="openSettings()"><i class="material-icons">settings</i> Settings</div>
            <div class="nav-item" onclick="openHelp()"><i class="material-icons">help</i> Help</div>
            <button class="btn" style="background:rgba(255,255,255,0.1); color:white; justify-content: flex-start; padding-left:20px; width:100%;" onclick="logout()">
                <i class="material-icons">logout</i> Sign Out
            </button>
        </div>
    </div>

    <div class="content-area">
        <div id="view-dashboard" class="view-section">
            <div class="stats-grid">
                <div class="stat-box" style="border-bottom: 4px solid var(--secondary);" onclick="openDrillDown('TOTAL')">
                    <h2 id="d-total">0</h2><span>Total Items</span>
                </div>
                <div class="stat-box" style="border-bottom: 4px solid #fbc02d;" onclick="openDrillDown('LOW')">
                    <h2 id="d-low">0</h2><span style="color:var(--danger)">Low Stock</span>
                </div>
                <div class="stat-box" style="border-bottom: 4px solid #e53935;" onclick="openDrillDown('EXPIRE')">
                    <h2 id="d-expire">0</h2><span style="color:#e53935;">Expiring Soon</span>
                </div>
            </div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0; color:var(--primary);">Stock Volume by Category</h3>
                </div>
                <div class="graph-container" id="bar-graph"></div>
            </div>
            <div class="split-dashboard">
                <div class="card">
                    <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:15px; color:var(--primary);">
                        <i class="material-icons" style="vertical-align:middle; color:var(--accent);">trending_up</i> Top 5 Most Used
                    </h3>
                    <div id="trend-list"></div>
                </div>
                <div class="card" style="background:#fffcf5; border:1px solid #ffe0b2;">
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #fae0b5; padding-bottom:15px;">
                        <h3 style="margin:0; color:#e65100;"><i class="material-icons" style="vertical-align:middle;">restaurant_menu</i> Menu Highlights</h3>
                        <i id="edit-menu-btn" class="material-icons" style="cursor:pointer; color:#ef6c00; display:none;" onclick="editBestSellers()">edit</i>
                    </div>
                    <div id="menu-best-list" style="font-size:14px; line-height:1.8; color:#bf360c; margin-top:15px; white-space: pre-line;"></div>
                </div>
            </div>
        </div>

        <div id="view-inventory" class="view-section" style="display:none;">
            <div class="card no-print">
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px; align-items:end;">
                    <div><h3 style="margin-top:0;">Stock Management</h3><p style="font-size:13px; color:#666;">Add or Deduct Items.</p></div>
                    <div>
                         <label style="font-size:11px; font-weight:bold; color:var(--primary);">ACTION</label>
                         <select id="stock-action-type" style="background: #f0f4f8; font-weight:bold;" onchange="toggleDateInput()">
                             <option value="IN">➕ STOCK IN (Restock)</option>
                             <option value="OUT">➖ STOCK OUT (Usage)</option>
                         </select>
                    </div>
                </div>
                <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:15px;">
                    <div>
                        <label style="font-size:11px; color:#888;">Category</label>
                        <div style="display:flex; gap:2px;">
                            <select id="inv-cat"></select>
                            <button onclick="manageCustom('category', 'add')" class="btn btn-primary btn-small" title="Add">+</button>
                            <button onclick="manageCustom('category', 'remove')" class="btn btn-danger btn-small" title="Delete">-</button>
                        </div>
                    </div>
                    <div>
                        <label style="font-size:11px; color:#888;">Item Name</label>
                        <input id="inv-name" placeholder="E.g. Coffee Beans">
                    </div>
                    <div>
                        <label style="font-size:11px; color:#888;">Quantity & Unit</label>
                        <div style="display:flex; gap:2px;">
                            <input id="inv-qty" type="number" placeholder="0">
                            <select id="inv-unit" style="width:90px;"></select>
                            <button onclick="manageCustom('unit', 'add')" class="btn btn-primary btn-small" title="Add">+</button>
                            <button onclick="manageCustom('unit', 'remove')" class="btn btn-danger btn-small" title="Delete">-</button>
                        </div>
                    </div>
                </div>
                <div id="expiry-wrapper" style="margin-top:15px;">
                     <label style="font-size:11px; font-weight:bold; color:#d32f2f;">Expiration Date</label>
                     <input id="inv-expiry" type="date">
                </div>
                <button class="btn" style="width:100%; margin-top:20px; background:var(--primary); color:white; padding:15px;" onclick="processStock()">CONFIRM TRANSACTION</button>
            </div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
                    <h3 style="margin:0;">Current Inventory</h3>
                    <input id="search-bar" onkeyup="renderInventory()" placeholder="Search items..." style="padding:10px; width: 200px;">
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead><tr><th>Item Name</th><th>Category</th><th>Quantity</th><th>Status / Expiry</th><th>Manage</th></tr></thead>
                        <tbody id="inventory-table-body"></tbody>
                    </table>
                </div>
                <div class="pagination no-print" style="display:flex; justify-content:center; gap:15px; margin-top:25px; align-items:center;">
                    <button class="btn btn-primary" onclick="changePage(-1)"><</button>
                    <span id="page-num" style="font-size:13px; font-weight:bold;">Page 1</span>
                    <button class="btn btn-primary" onclick="changePage(1)">></button>
                </div>
            </div>
        </div>

        <div id="view-reports" class="view-section" style="display:none;">
            <div class="card">
                <h3 style="margin-top:0;">Generate Reports</h3>
                <div class="no-print" style="margin:20px 0; background:#f9f9f9; padding:15px; border-radius:8px;">
                    <label style="font-size:12px; font-weight:bold; color:#666;">Date Range Filter (For Logs)</label>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <input type="date" id="report-start">
                        <input type="date" id="report-end">
                    </div>
                </div>
                <div class="no-print" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-top:25px;">
                    <button class="btn" style="background:#e3f2fd; color:#1565c0; flex-direction:column; padding:30px; border:1px solid #bbdefb;" onclick="exportReport('LOW')">
                        <i class="material-icons" style="font-size:32px; margin-bottom:10px;">warning</i> Low Stock Report
                    </button>
                    <button class="btn" style="background:#e8f5e9; color:#2e7d32; flex-direction:column; padding:30px; border:1px solid #c8e6c9;" onclick="exportReport('NEEDS')">
                        <i class="material-icons" style="font-size:32px; margin-bottom:10px;">shopping_cart</i> Purchase Plan
                    </button>
                    <button class="btn" style="background:#fff3e0; color:#ef6c00; flex-direction:column; padding:30px; border:1px solid #ffe0b2;" onclick="exportReport('LOGS')">
                        <i class="material-icons" style="font-size:32px; margin-bottom:10px;">list_alt</i> Transaction Logs
                    </button>
                    <button class="btn" style="background:#ffebee; color:#c62828; flex-direction:column; padding:30px; border:1px solid #ffcdd2;" onclick="exportReport('EXPIRED')">
                        <i class="material-icons" style="font-size:32px; margin-bottom:10px;">event_busy</i> Expired Items
                    </button>
                </div>
                <div id="print-area" style="display:none;"></div>
            </div>
        </div>

        <div id="view-history" class="view-section" style="display:none;">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Audit Trail Log</h3>
                    <button id="clear-logs-btn" class="btn btn-danger" style="font-size:12px; display:none;" onclick="clearLogs()">CLEAR HISTORY</button>
                </div>
                <div style="overflow-x:auto; margin-top:15px;">
                    <table style="font-size:13px;">
                        <thead><tr><th>Timestamp</th><th>User</th><th>Action</th><th>Item Details</th></tr></thead>
                        <tbody id="log-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-users" class="view-section" style="display:none;">
            <div class="card">
                <h3>User Management</h3>
                <div style="overflow-x:auto; margin-top:15px;">
                    <table><thead><tr><th>Username</th><th>Name</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead><tbody id="user-table-body"></tbody></table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="drill-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="drill-title" class="modal-title">Details</h3>
        <div id="cat-filters" class="cat-filters"></div>
        <div id="drill-list-container" class="drill-list" style="overflow-y:auto; flex:1; margin-bottom:15px;"></div>
        <div class="pagination" style="display:flex; justify-content:space-between; align-items:center; border-top:1px solid #eee; padding-top:15px;">
             <button class="btn btn-primary" onclick="changeDrillPage(-1)"><</button>
             <span id="drill-page-num" style="font-size:12px;">Page 1</span>
             <button class="btn btn-primary" onclick="changeDrillPage(1)">></button>
        </div>
        <button class="btn" style="width:100%; margin-top:15px; background:#ddd; color:#444;" onclick="document.getElementById('drill-modal').style.display='none'">Close</button>
    </div>
</div>

<div id="register-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 class="modal-title">New Operative Registration</h3>
        <div class="form-group"><label>Admin Authorization Code</label><input id="reg-auth-code" class="form-control" type="password" placeholder="Required for access"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div class="form-group"><label>Username</label><input id="reg-user" class="form-control" placeholder="lowercase"></div>
            <div class="form-group"><label>Role</label><select id="reg-role" class="form-control"><option value="Staff">Staff</option><option value="Chef">Chef</option><option value="Manager">Manager</option><option value="Admin">Admin</option></select></div>
        </div>
        <div class="form-group"><label>Password</label><input id="reg-pass" class="form-control" type="password"></div>
        <hr style="border:0; border-top:1px solid #eee; margin: 10px 0 20px 0;">
        <h4 style="margin:0 0 10px 0; font-size:13px; color:var(--primary);">Personal Details</h4>
        <div class="form-group"><label>Full Name</label><input id="reg-name" class="form-control" placeholder="Display Name"></div>
        <div class="form-group"><label>Birthday</label><input id="reg-bday" class="form-control" type="date"></div>
        <div class="file-upload-wrapper" onclick="document.getElementById('reg-pic-file').click()">
            <input type="file" id="reg-pic-file" style="display:none;" accept="image/*" onchange="previewImage(this, 'reg-preview')">
            <i class="material-icons" style="color:#ccc;">cloud_upload</i>
            <div style="font-size:12px; color:#888;">Click to upload Photo (Optional)</div>
            <img id="reg-preview" style="width:50px; height:50px; border-radius:50%; margin-top:10px; display:none; object-fit:cover;">
        </div>
        <button class="btn btn-primary" style="width:100%; padding:12px;" onclick="submitRegistration()">CREATE ACCOUNT</button>
        <button class="btn" style="width:100%; margin-top:10px; background:#f0f0f0; color:#666;" onclick="document.getElementById('register-modal').style.display='none'">Cancel</button>
    </div>
</div>

<div id="profile-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 class="modal-title">Edit Profile</h3>
        <div style="text-align:center; margin-bottom:20px;">
            <img id="edit-profile-img" src="" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:3px solid var(--accent);">
            <div style="margin-top:10px;">
                <label class="btn btn-small btn-primary" style="cursor:pointer;">
                    Change Photo <input type="file" style="display:none;" accept="image/*" onchange="previewImage(this, 'edit-profile-img')">
                </label>
            </div>
        </div>
        <div class="form-group"><label>Full Name</label><input id="edit-name" class="form-control"></div>
        <div class="form-group"><label>Birthday</label><input id="edit-bday" class="form-control" type="date"></div>
        <div class="form-group"><label>New Password (Leave blank to keep current)</label><input id="edit-pass" class="form-control" type="password"></div>
        <button class="btn btn-primary" style="width:100%; padding:12px;" onclick="saveProfileChanges()">SAVE CHANGES</button>
        <button class="btn" style="width:100%; margin-top:10px; background:#f0f0f0; color:#666;" onclick="document.getElementById('profile-modal').style.display='none'">Cancel</button>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 class="modal-title">System Settings</h3>
        <div style="margin-bottom:20px;">
            <h4>Appearance</h4>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="background:#eee; color:#333;" onclick="setTheme('light')">Light Mode</button>
                <button class="btn" style="background:#333; color:#fff;" onclick="setTheme('dark')">Dark Mode</button>
            </div>
        </div>
        <div style="margin-bottom:20px;">
            <h4>Data Backup & Recovery</h4>
            <p style="font-size:12px; color:#666; margin-bottom:10px;">Download your entire database or restore from a file.</p>
            <button class="btn btn-success" style="width:100%; margin-bottom:10px;" onclick="backupData()">Download Backup (.json)</button>
            <label class="btn btn-primary" style="width:100%; cursor:pointer;">
                Restore from Backup <input type="file" id="restore-file" accept=".json" style="display:none;" onchange="restoreData(this)">
            </label>
        </div>
        <button class="btn" style="width:100%; margin-top:10px; background:#ddd; color:#444;" onclick="document.getElementById('settings-modal').style.display='none'">Close</button>
    </div>
</div>

<div id="help-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 class="modal-title">User Manual</h3>
        <div style="font-size:13px; line-height:1.6; color:#555;">
            <p><b>Stock In/Out:</b> Navigate to 'Inventory'. Select action (IN/OUT), Item, Category, and Qty. Use 'IN' for restock and 'OUT' for usage.</p>
            <p><b>Alerts:</b> The Bell icon shows Low Stock (<=5) and Expiring items. Furniture/Machines are excluded from low stock alerts.</p>
            <p><b>Reports:</b> Go to 'Reports'. Select a date range if you want specific Logs. Click a report button to download CSV or print.</p>
            <p><b>Admin:</b> Admins can manage users via the 'Users' tab in the sidebar (Deactivate/Reset Password).</p>
            <p><b>Backup:</b> Use Settings > Backup to save your data safely.</p>
        </div>
        <button class="btn" style="width:100%; margin-top:15px; background:#ddd; color:#444;" onclick="document.getElementById('help-modal').style.display='none'">Close</button>
    </div>
</div>

<script>
/* --- CONFIG & DATA --- */
const baseAccounts = {
    "quita": { pass: "Quita246", role: "Admin", name: "Quita", pic: "admin.png", active: true },
    "omlang": { pass: "Omlang246", role: "Manager", name: "Omlang", pic: "manager.png", active: true },
    "briones": { pass: "Briones246", role: "Chef", name: "Briones", pic: "chef.png", active: true },
    "decastro": { pass: "Staff246", role: "Staff", name: "Decastro", pic: "decastro.png", active: true },
    "ewayan": { pass: "Staff246", role: "Staff", name: "Ewayan", pic: "ewayan.png", active: true },
    "tan": { pass: "Staff246", role: "Staff", name: "Tan", pic: "tan.png", active: true }
};

let db, logs, categories, units, menuBestSellers, customUsers;
const EXCLUDED_FROM_ALERTS = ["Machines", "Furniture"];
const AUTH_CODE = "DEJA2026";

/* --- INIT --- */
document.addEventListener("DOMContentLoaded", () => {
    loadData();
    setTimeout(() => {
        document.getElementById("splash").style.display = "none";
        document.getElementById("login").style.display = "flex";
    }, 2000); 
    toggleDateInput();
});

function loadData() {
    try {
        db = JSON.parse(localStorage.getItem("db_inventory")) || {};
        logs = JSON.parse(localStorage.getItem("db_logs")) || [];
        // Ensure Furniture is in categories
        let defaultCats = ["Ingredients", "Machines", "Furniture", "Packaging", "Utensils"];
        categories = JSON.parse(localStorage.getItem("db_cats")) || defaultCats;
        if(!categories.includes("Furniture")) { categories.push("Furniture"); }
        
        units = JSON.parse(localStorage.getItem("db_units")) || ["kg", "pcs", "packs", "liters", "cans"];
        menuBestSellers = localStorage.getItem("db_menu_best") || "1. Caramel Macchiato\n2. Croissant\n3. Iced Americano";
        customUsers = JSON.parse(localStorage.getItem("db_users")) || {};
        
        // Merge base accounts into customUsers structure for management if not present
        Object.entries(baseAccounts).forEach(([k, v]) => {
            if (!customUsers[k]) customUsers[k] = v;
        });

        populateSelects();
    } catch(e) {
        showToast("Storage Error: Data reset.", "error");
        db={}; logs=[]; categories=["Ingredients"]; units=["pcs"]; customUsers={};
    }
}

/* --- UTILS --- */
function showToast(msg, type='info') {
    const t = document.getElementById("toast");
    t.innerText = msg;
    t.className = type === 'error' ? 'show error' : (type === 'success' ? 'show success' : 'show');
    setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
}

function populateSelects() {
    const catSel = document.getElementById("inv-cat");
    const unitSel = document.getElementById("inv-unit");
    catSel.innerHTML = categories.map(c => `<option>${c}</option>`).join('');
    unitSel.innerHTML = units.map(u => `<option>${u}</option>`).join('');
}

/* --- AUTH & SESSION --- */
let currentUser = null;
let sessionTimer;
let timeLeft = 300; 

function authenticate() {
    try {
        const role = document.getElementById("role-select").value;
        const u = document.getElementById("user-input").value.trim().toLowerCase();
        const p = document.getElementById("pass-input").value;

        let account = customUsers[u];

        if (account && account.pass === p && account.role === role) {
            if(account.active === false) {
                showToast("Account Deactivated. Contact Admin.", "error");
                return;
            }
            currentUser = { username: u, ...account }; 
            document.getElementById("login").style.display = "none";
            document.getElementById("main-app").style.display = "flex"; 
            
            updateProfileUI();
            
            if(currentUser.role === 'Admin' || currentUser.role === 'Manager') {
                document.getElementById("edit-menu-btn").style.display = "inline-block";
            }
            if(currentUser.role === 'Admin') {
                document.getElementById("clear-logs-btn").style.display = "block";
                document.getElementById("admin-user-nav").style.display = "flex"; // Show User Management
            }
            
            startSession();
            checkNotifications();
            nav('dashboard');
        } else {
            showToast("Access Denied: Invalid Credentials", "error");
        }
    } catch(e) { showToast("Login Error", "error"); }
}

function logout() { location.reload(); }

function startSession() {
    clearInterval(sessionTimer);
    timeLeft = 300; 
    const timerDisplay = document.getElementById("timer");
    sessionTimer = setInterval(() => {
        timeLeft--;
        let m = Math.floor(timeLeft / 60);
        let s = timeLeft % 60;
        timerDisplay.innerText = `${m}:${s < 10 ? '0'+s : s}`;
        if(timeLeft <= 0) logout();
    }, 1000);
}
function resetTimer() { timeLeft = 300; }

function forgotPass() {
    showToast("Please contact an Admin to reset your password.", "warning");
}

/* --- NAVIGATION --- */
function nav(viewId) {
    try {
        document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${viewId}`).style.display = 'block';
        
        const titles = {
            'dashboard': 'DEJA BREW - DASHBOARD',
            'inventory': 'DEJA BREW - INVENTORY',
            'reports': 'DEJA BREW - REPORTS',
            'history': 'DEJA BREW - LOGS',
            'users': 'DEJA BREW - USER MANAGEMENT'
        };
        document.getElementById("page-title").innerText = titles[viewId] || "DEJA BREW INVENTORY MANAGEMENT";

        // Highlight active nav
        if(viewId === 'dashboard') { document.querySelectorAll('.nav-item')[0].classList.add('active'); renderDashboard(); }
        if(viewId === 'inventory') { document.querySelectorAll('.nav-item')[1].classList.add('active'); renderInventory(); }
        if(viewId === 'reports') document.querySelectorAll('.nav-item')[2].classList.add('active');
        if(viewId === 'history') { document.querySelectorAll('.nav-item')[3].classList.add('active'); renderLogs(); }
        if(viewId === 'users') { document.getElementById('admin-user-nav').classList.add('active'); renderUsers(); }

        if(window.innerWidth < 900) toggleSidebar();
    } catch(e) { console.error("Nav error", e); }
}

function toggleSidebar() { document.getElementById("sidebar").classList.toggle("active"); }

/* --- INVENTORY LOGIC --- */
function manageCustom(type, action) {
    try {
        if(action === 'add') {
            const val = prompt(`Enter new ${type}:`);
            if(val && val.trim() !== "") {
                if(type === 'category') { 
                    if(!categories.includes(val)) categories.push(val); 
                    localStorage.setItem("db_cats", JSON.stringify(categories)); 
                }
                if(type === 'unit') { 
                    if(!units.includes(val)) units.push(val); 
                    localStorage.setItem("db_units", JSON.stringify(units)); 
                }
                populateSelects();
                showToast(`${type} added`);
            }
        } else if (action === 'remove') {
            const current = document.getElementById(type === 'category' ? "inv-cat" : "inv-unit").value;
            if(confirm(`Delete ${type} "${current}"?`)) {
                if(type === 'category') {
                    categories = categories.filter(c => c !== current);
                    if(categories.length === 0) categories.push("General");
                    localStorage.setItem("db_cats", JSON.stringify(categories));
                }
                if(type === 'unit') {
                    units = units.filter(u => u !== current);
                    if(units.length === 0) units.push("pcs");
                    localStorage.setItem("db_units", JSON.stringify(units));
                }
                populateSelects();
                showToast(`${type} removed`);
            }
        }
    } catch(e) { showToast("Error", "error"); }
}

function toggleDateInput() {
    const type = document.getElementById("stock-action-type").value;
    document.getElementById("expiry-wrapper").style.display = (type === 'IN') ? 'block' : 'none';
}

function processStock() {
    try {
        const type = document.getElementById("stock-action-type").value; 
        const name = document.getElementById("inv-name").value.trim().toUpperCase();
        const qtyVal = document.getElementById("inv-qty").value;
        const qty = parseFloat(qtyVal);
        const cat = document.getElementById("inv-cat").value;
        const unit = document.getElementById("inv-unit").value;
        const expiry = document.getElementById("inv-expiry").value;

        if(!name) return showToast("Enter item name", "error");
        if(isNaN(qty) || qty <= 0) return showToast("Invalid Quantity", "error");

        if(!db[name]) {
            db[name] = { qty: 0, cat: cat, unit: unit, expiry: '', lastUpdated: Date.now(), stockOutCount: 0 };
        }

        if(type === 'IN') {
            db[name].qty += qty;
            db[name].cat = cat; 
            db[name].unit = unit;
            if(expiry) db[name].expiry = expiry; 
            db[name].lastUpdated = Date.now();
        } else {
            if(db[name].qty < qty) return showToast("Insufficient Stock!", "error");
            db[name].qty -= qty;
            db[name].stockOutCount += qty;
        }

        localStorage.setItem("db_inventory", JSON.stringify(db));
        logTx(type, name, qty);
        
        document.getElementById("inv-name").value = "";
        document.getElementById("inv-qty").value = "";
        document.getElementById("inv-expiry").value = "";
        renderInventory();
        checkNotifications();
        showToast("Transaction Successful!", "success");
    } catch(e) { showToast("Transaction Failed", "error"); }
}

function deleteItem(name) {
    if(confirm("Delete item permanently?")) {
        delete db[name];
        localStorage.setItem("db_inventory", JSON.stringify(db));
        renderInventory();
    }
}

/* --- RENDER INVENTORY --- */
let currentPage = 1;
const itemsPerPage = 8;

function renderInventory() {
    const tbody = document.getElementById("inventory-table-body");
    tbody.innerHTML = "";
    const search = document.getElementById("search-bar").value.toLowerCase();

    let list = Object.entries(db).map(([k, v]) => ({name: k, ...v}));
    list.sort((a,b) => b.lastUpdated - a.lastUpdated); 
    list = list.filter(item => item.name.toLowerCase().includes(search) || item.cat.toLowerCase().includes(search));

    const totalPages = Math.ceil(list.length / itemsPerPage) || 1;
    if(currentPage > totalPages) currentPage = totalPages;
    const start = (currentPage - 1) * itemsPerPage;
    const pageItems = list.slice(start, start + itemsPerPage);

    document.getElementById("page-num").innerText = `Page ${currentPage} of ${totalPages}`;

    pageItems.forEach(item => {
        let expInfo = item.expiry ? `<span style="color:${new Date(item.expiry) < new Date() ? 'red' : '#333'}; font-weight:bold;">${item.expiry}</span>` : '<span style="color:#aaa;">-</span>';
        
        // CHECK EXCLUSION FOR LOW STOCK
        const isExcluded = EXCLUDED_FROM_ALERTS.includes(item.cat);
        const isLow = !isExcluded && item.qty <= 5;

        tbody.innerHTML += `
        <tr>
            <td><b>${item.name}</b></td>
            <td><span style="background:#f0f0f0; padding:4px 10px; border-radius:12px; font-size:11px;">${item.cat}</span></td>
            <td style="color:${isLow ? 'var(--danger)' : 'inherit'}; font-weight:bold;">${item.qty} ${item.unit}</td>
            <td>${expInfo}</td>
            <td>${currentUser.role === 'Admin' ? `<button onclick="deleteItem('${item.name}')" style="background:none; border:none; color:#888; cursor:pointer;"><i class="material-icons">delete</i></button>` : ''}</td>
        </tr>`;
    });
}
function changePage(dir) {
    if(dir === 1) currentPage++;
    else if (currentPage > 1) currentPage--;
    renderInventory();
}

/* --- DASHBOARD --- */
function renderDashboard() {
    let totalItems = 0, lowStock = 0, expiring = 0;
    let trendArr = [];
    let catCounts = {}; 
    const today = new Date();

    Object.entries(db).forEach(([name, item]) => {
        totalItems++;
        
        const isExcluded = EXCLUDED_FROM_ALERTS.includes(item.cat);
        if(!isExcluded && item.qty <= 5) lowStock++;
        
        if(item.expiry) {
            const diff = (new Date(item.expiry) - today) / (1000*60*60*24);
            if(diff <= 7 && diff >= -30) expiring++; 
        }
        if(item.stockOutCount > 0) trendArr.push({name: name, count: item.stockOutCount});
        
        if(!catCounts[item.cat]) catCounts[item.cat] = 0;
        catCounts[item.cat] += item.qty;
    });

    document.getElementById("d-total").innerText = totalItems;
    document.getElementById("d-low").innerText = lowStock;
    document.getElementById("d-expire").innerText = expiring;

    trendArr.sort((a,b) => b.count - a.count);
    const trendList = document.getElementById("trend-list");
    trendList.innerHTML = "";
    if(trendArr.length === 0) trendList.innerHTML = "<small>No data yet.</small>";
    
    trendArr.slice(0, 5).forEach((t, i) => {
        trendList.innerHTML += `<div class="list-item"><span><span class="rank-badge">${i+1}</span> ${t.name}</span> <b>${t.count} used</b></div>`;
    });

    document.getElementById("menu-best-list").innerText = menuBestSellers;
    renderGraph(catCounts);
}

function renderGraph(data) {
    const container = document.getElementById("bar-graph");
    container.innerHTML = "";
    const keys = Object.keys(data);
    if(keys.length === 0) { container.innerHTML = "<small>No data.</small>"; return; }
    const maxVal = Math.max(...Object.values(data));

    keys.forEach(cat => {
        const val = data[cat];
        const height = maxVal > 0 ? (val / maxVal) * 100 : 0;
        const finalHeight = height < 15 ? 15 : height; 
        container.innerHTML += `
        <div class="bar-group">
             <div style="font-size:10px; font-weight:bold; margin-bottom:5px;">${val}</div>
             <div class="bar" style="height:${finalHeight}px;" title="${cat}: ${val}"></div>
             <div style="font-size:10px; color:#666; margin-top:5px;">${cat.substring(0,6)}..</div>
        </div>`;
    });
}

function editBestSellers() {
    const input = prompt("Enter Menu Highlights:", menuBestSellers);
    if(input !== null) {
        menuBestSellers = input;
        localStorage.setItem("db_menu_best", menuBestSellers);
        renderDashboard();
    }
}

/* --- DRILL DOWN --- */
let drillAllItems = [];
let currentDrillCat = "All";
let drillPage = 1;
const drillPerPage = 6;

function openDrillDown(type) {
    const today = new Date();
    drillAllItems = []; 
    drillPage = 1;
    currentDrillCat = "All";
    document.getElementById("drill-modal").style.display = "flex";
    
    let title = "";
    Object.entries(db).forEach(([name, item]) => {
        let include = false;
        let extraInfo = `${item.qty} ${item.unit}`;
        
        if(type === 'TOTAL') { title = "Total Inventory"; include = true; }
        else if (type === 'LOW') { 
            title = "Low Stock Alerts"; 
            const isExcluded = EXCLUDED_FROM_ALERTS.includes(item.cat);
            if(!isExcluded && item.qty <= 5) { 
                include = true; 
                extraInfo = `<span style="color:red; font-weight:bold;">${item.qty} ${item.unit}</span>`; 
            }
        }
        else if (type === 'EXPIRE') {
            title = "Expiring / Expired";
            if(item.expiry) {
                const diff = (new Date(item.expiry) - today) / (1000*60*60*24);
                if(diff <= 7) { include = true; extraInfo = `Exp: ${item.expiry}`; }
            }
        }
        if(include) drillAllItems.push({ name: name, cat: item.cat, info: extraInfo });
    });
    document.getElementById("drill-title").innerText = title;
    renderCategoryFilters();
    renderDrillDownList();
}
function renderCategoryFilters() {
    const filterContainer = document.getElementById("cat-filters");
    let availableCats = ["All", ...categories];
    filterContainer.innerHTML = availableCats.map(cat => `<div class="cat-chip ${cat === currentDrillCat ? 'active' : ''}" onclick="filterDrillCat('${cat}')">${cat}</div>`).join('');
}
function filterDrillCat(cat) { currentDrillCat = cat; drillPage = 1; renderCategoryFilters(); renderDrillDownList(); }
function renderDrillDownList() {
    const container = document.getElementById("drill-list-container");
    container.innerHTML = "";
    let filtered = (currentDrillCat === "All") ? drillAllItems : drillAllItems.filter(i => i.cat === currentDrillCat);
    filtered.sort((a,b) => a.name.localeCompare(b.name));
    if(filtered.length === 0) { container.innerHTML = `<div style="padding:20px; text-align:center; color:#999;">No items found.</div>`; document.getElementById("drill-page-num").innerText = "-"; return; }
    const totalPages = Math.ceil(filtered.length / drillPerPage) || 1;
    if(drillPage > totalPages) drillPage = totalPages;
    const start = (drillPage - 1) * drillPerPage;
    const itemsToShow = filtered.slice(start, start + drillPerPage);
    document.getElementById("drill-page-num").innerText = `Page ${drillPage}/${totalPages}`;
    itemsToShow.forEach(item => {
        container.innerHTML += `<div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #f0f0f0; font-size:14px;"><span><b>${item.name}</b> <span style="color:#999; font-size:12px;">(${item.cat})</span></span><span>${item.info}</span></div>`;
    });
}
function changeDrillPage(dir) {
    let filteredLen = (currentDrillCat === "All") ? drillAllItems.length : drillAllItems.filter(i => i.cat === currentDrillCat).length;
    const totalPages = Math.ceil(filteredLen / drillPerPage) || 1;
    if(dir === 1 && drillPage < totalPages) drillPage++;
    else if (dir === -1 && drillPage > 1) drillPage--;
    renderDrillDownList();
}

/* --- LOGS & REPORTS --- */
function logTx(action, item, qty) {
    logs.unshift({ date: new Date().toLocaleString(), user: currentUser.username, action: action, item: item, qty: qty });
    if(logs.length > 150) logs.pop();
    localStorage.setItem("db_logs", JSON.stringify(logs));
}
function renderLogs() {
    document.getElementById("log-table-body").innerHTML = logs.map(l => `<tr><td>${l.date}</td><td>${l.user}</td><td style="color:${l.action==='IN'?'green':'red'}">${l.action}</td><td>${l.item} (${l.qty})</td></tr>`).join('');
}
function clearLogs() { if(confirm("Clear Audit Trail?")) { logs = []; localStorage.setItem("db_logs", JSON.stringify(logs)); renderLogs(); } }

function exportReport(type) {
    try {
        if(confirm("Do you want to print this report?")) {
            window.print();
            return;
        }
        let csv = "data:text/csv;charset=utf-8,";
        const startDate = document.getElementById("report-start").value;
        const endDate = document.getElementById("report-end").value;

        if(type === 'LOGS') { 
            csv += "Date,User,Action,Item,Qty\n"; 
            let filteredLogs = logs;
            if(startDate && endDate) {
                filteredLogs = logs.filter(l => {
                    let d = new Date(l.date);
                    return d >= new Date(startDate) && d <= new Date(endDate);
                });
            }
            filteredLogs.forEach(l => csv += `${l.date},${l.user},${l.action},${l.item},${l.qty}\n`); 
        }
        else if (type === 'LOW') { 
            csv += "Category,Item,Qty,Unit\n"; 
            Object.entries(db).forEach(([k,v]) => { if(v.qty<=5 && !EXCLUDED_FROM_ALERTS.includes(v.cat)) csv += `${v.cat},${k},${v.qty},${v.unit}\n`; }); 
        }
        else if (type === 'NEEDS') { 
            csv += "Item,Sold,Estimated Need\n"; 
            Object.entries(db).forEach(([k,v]) => { csv += `${k},${v.stockOutCount},${v.stockOutCount}\n`; }); 
        }
        else if (type === 'EXPIRED') {
            csv += "Category,Item,Qty,Expiry Date,Status\n";
            const today = new Date();
            Object.entries(db).forEach(([k,v]) => {
                if(v.expiry) {
                    const expDate = new Date(v.expiry);
                    if(expDate < today) csv += `${v.cat},${k},${v.qty},${v.expiry},EXPIRED\n`;
                }
            });
        }
        const link = document.createElement("a"); link.href = encodeURI(csv); link.download = `report_${type.toLowerCase()}.csv`; link.click();
        showToast("Report Downloaded", "success");
    } catch(e) { showToast("Export Failed", "error"); }
}

/* --- ADMIN: USER MANAGEMENT --- */
function renderUsers() {
    const tbody = document.getElementById("user-table-body");
    tbody.innerHTML = "";
    Object.entries(customUsers).forEach(([u, acc]) => {
        tbody.innerHTML += `
        <tr>
            <td>${u}</td>
            <td>${acc.name}</td>
            <td>${acc.role}</td>
            <td>${acc.active !== false ? '<span style="color:var(--success)">Active</span>' : '<span style="color:var(--danger)">Inactive</span>'}</td>
            <td>
                <button class="btn btn-small btn-secondary" onclick="toggleUserStatus('${u}')">${acc.active !== false ? 'Deactivate' : 'Activate'}</button>
                <button class="btn btn-small btn-danger" onclick="resetUserPass('${u}')">Reset</button>
            </td>
        </tr>`;
    });
}
function toggleUserStatus(username) {
    if(username === currentUser.username) return showToast("Cannot deactivate yourself", "error");
    customUsers[username].active = (customUsers[username].active === false) ? true : false;
    localStorage.setItem("db_users", JSON.stringify(customUsers));
    renderUsers();
}
function resetUserPass(username) {
    const newPass = prompt("Enter new password for " + username);
    if(newPass) {
        customUsers[username].pass = newPass;
        localStorage.setItem("db_users", JSON.stringify(customUsers));
        showToast("Password Reset Successful", "success");
    }
}

/* --- SETTINGS & NOTIFICATIONS --- */
function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    showToast("Theme Updated", "success");
}

function backupData() {
    const data = { db: db, logs: logs, users: customUsers, categories: categories };
    const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "dejabrew_backup_" + new Date().toISOString().slice(0,10) + ".json";
    a.click();
}

function restoreData(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if(data.db && data.users) {
                localStorage.setItem("db_inventory", JSON.stringify(data.db));
                localStorage.setItem("db_logs", JSON.stringify(data.logs));
                localStorage.setItem("db_users", JSON.stringify(data.users));
                localStorage.setItem("db_cats", JSON.stringify(data.categories));
                alert("System Restored. Reloading...");
                location.reload();
            } else { throw new Error("Invalid Format"); }
        } catch(err) { showToast("Invalid Backup File", "error"); }
    };
    reader.readAsText(file);
}

function checkNotifications() {
    const list = document.getElementById("notif-dropdown");
    const badge = document.getElementById("notif-count");
    list.innerHTML = "";
    let count = 0;
    
    // Low Stock (Exclude Furniture/Machines)
    Object.entries(db).forEach(([k,v]) => {
        if(!EXCLUDED_FROM_ALERTS.includes(v.cat) && v.qty <= 5) {
            count++;
            list.innerHTML += `<div class="notif-item notif-danger"><i class="material-icons" style="font-size:16px; color:var(--danger)">warning</i> ${k} is low (${v.qty} ${v.unit})</div>`;
        }
    });
    
    // Expiring
    const today = new Date();
    Object.entries(db).forEach(([k,v]) => {
        if(v.expiry) {
            const diff = (new Date(v.expiry) - today) / (1000*60*60*24);
            if(diff <= 7 && diff >= 0) {
                count++;
                list.innerHTML += `<div class="notif-item notif-warning"><i class="material-icons" style="font-size:16px; color:var(--warning)">history</i> ${k} expires in ${Math.ceil(diff)} days</div>`;
            }
        }
    });
    
    if(count > 0) {
        badge.innerText = count;
        badge.style.display = "flex";
    } else {
        badge.style.display = "none";
        list.innerHTML = "<div style='padding:15px; text-align:center; color:#888;'>No new alerts</div>";
    }
}
function toggleNotif() {
    const el = document.getElementById("notif-dropdown");
    el.style.display = el.style.display === "block" ? "none" : "block";
}

/* --- REGISTRATION & PROFILE --- */
let tempRegImg = "";
function openRegisterModal() {
    document.getElementById("register-modal").style.display = "flex";
    tempRegImg = ""; 
    document.getElementById("reg-preview").style.display = "none";
}
function openProfileModal() {
    document.getElementById("profile-modal").style.display = "flex";
    document.getElementById("edit-name").value = currentUser.name;
    document.getElementById("edit-bday").value = currentUser.bday || "";
    document.getElementById("edit-profile-img").src = currentUser.pic || "logo.png";
}
function openSettings() { document.getElementById("settings-modal").style.display = "flex"; }
function openHelp() { document.getElementById("help-modal").style.display = "flex"; }

function previewImage(input, previewId) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById(previewId).src = e.target.result;
            document.getElementById(previewId).style.display = "block";
            if(previewId === 'reg-preview') tempRegImg = e.target.result;
        }
        reader.readAsDataURL(input.files[0]);
    }
}

function submitRegistration() {
    if(document.getElementById("reg-auth-code").value !== AUTH_CODE) return showToast("Invalid Authorization Code", "error");
    const u = document.getElementById("reg-user").value.trim().toLowerCase();
    const p = document.getElementById("reg-pass").value;
    const r = document.getElementById("reg-role").value;
    const n = document.getElementById("reg-name").value;
    const b = document.getElementById("reg-bday").value;
    
    if(!u || !p || !n) return showToast("Please fill all fields", "error");
    if(customUsers[u]) return showToast("Username taken", "error");
    
    customUsers[u] = { pass: p, role: r, name: n, bday: b, pic: tempRegImg || "logo.png", active: true };
    localStorage.setItem("db_users", JSON.stringify(customUsers));
    showToast("Registration Successful", "success");
    document.getElementById("register-modal").style.display="none";
}

function saveProfileChanges() {
    const newName = document.getElementById("edit-name").value;
    const newBday = document.getElementById("edit-bday").value;
    const newPass = document.getElementById("edit-pass").value;
    const newPic = document.getElementById("edit-profile-img").src;

    currentUser.name = newName;
    currentUser.bday = newBday;
    currentUser.pic = newPic;
    if(newPass) currentUser.pass = newPass;

    customUsers[currentUser.username] = { ...currentUser };
    // Don't save 'username' key inside object if not needed, but keep data consistent
    delete customUsers[currentUser.username].username; 
    
    localStorage.setItem("db_users", JSON.stringify(customUsers));
    updateProfileUI();
    document.getElementById("profile-modal").style.display = "none";
    showToast("Profile Updated", "success");
}

function updateProfileUI() {
    document.getElementById("prof-name").innerText = currentUser.name;
    document.getElementById("prof-role").innerText = currentUser.role;
    document.getElementById("prof-pic").src = currentUser.pic || 'logo.png';
}
</script>
</body>
</html>