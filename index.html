<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deja Brew Inventory Management</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
/* ===== GLOBAL STYLES ===== */
:root {
    --primary: #3e2723;
    --secondary: #6f4e37;
    --accent: #ffd180;
    --bg: #fdfaf6;
    --text: #333;
    --danger: #c62828;
    --success: #2e7d32;
}
* { box-sizing: border-box; }
body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--primary); color: var(--text); overflow-x: hidden; }

/* LAYOUT & UTILS */
section { display: none; min-height: 100vh; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
.btn { border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
.btn:active { transform: scale(0.96); }
.btn-primary { background: var(--secondary); color: white; }
.btn-accent { background: var(--accent); color: var(--primary); }
.flex-row { display: flex; gap: 10px; width: 100%; }
.card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; width: 100%; }

/* SPLASH SCREEN */
#splash { display: flex; color: white; text-align: center; cursor: pointer; }
.logo-anim { width: 150px; animation: pulse 2s infinite ease-in-out; margin-bottom: 20px; border-radius: 50%; border: 4px solid var(--accent); }
@keyframes pulse { 0% { transform: scale(0.95); opacity: 0.9; } 50% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(0.95); opacity: 0.9; } }

/* LOGIN BOX */
#login { display: none; background: rgba(0,0,0,0.85); color: white; }
.login-box { background: rgba(255,255,255,0.05); padding: 30px; border-radius: 15px; border: 1px solid var(--secondary); text-align: center; width: 100%; max-width: 400px; }
.login-logo { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent); margin-bottom: 15px; background: white; object-fit: cover; }
#login select, #login input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; font-size: 14px; }

/* DASHBOARD SHELL */
#main-app { display: none; background: var(--bg); min-height: 100vh; flex-direction: column; }

.top-nav { height: 60px; background: var(--primary); color: var(--accent); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; position: fixed; top: 0; width: 100%; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
.sidebar { width: 280px; background: var(--primary); padding: 20px; position: fixed; top: 60px; bottom: 0; left: 0; transform: translateX(-100%); transition: 0.3s; z-index: 999; border-right: 2px solid var(--secondary); display: flex; flex-direction: column; }
.sidebar.active { transform: translateX(0); }

/* MAIN CONTENT AREA */
.content-area { margin-top: 60px; padding: 20px; transition: 0.3s; }
@media (min-width: 800px) {
    .sidebar { transform: translateX(0); }
    .content-area { margin-left: 280px; }
    .menu-trigger { display: none; }
}

/* SIDEBAR ITEMS */
.profile-card { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; color: white; }
.nav-item { padding: 12px; margin-bottom: 5px; border-radius: 8px; color: white; display: flex; align-items: center; gap: 10px; cursor: pointer; opacity: 0.8; }
.nav-item:hover, .nav-item.active { background: var(--secondary); opacity: 1; border-left: 4px solid var(--accent); }

/* DASHBOARD WIDGETS */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
.stat-box { background: white; padding: 20px; border-radius: 12px; text-align: center; border-bottom: 4px solid var(--primary); cursor: pointer; transition: 0.2s; }
.stat-box:active { transform: scale(0.95); background: #eee; }
.stat-box h2 { margin: 5px 0; font-size: 28px; color: var(--primary); }
.stat-box span { font-size: 11px; color: #777; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }

.trend-list li { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
.badge { padding: 2px 8px; border-radius: 10px; font-size: 10px; color: white; font-weight: bold; }

/* INVENTORY LIST */
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th { background: var(--secondary); color: white; padding: 10px; text-align: left; font-size: 12px; }
td { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }
.pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; align-items: center; }

/* MODALS & DRILL DOWN */
.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
.modal-content { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 500px; max-height: 85vh; display: flex; flex-direction: column; }
.drill-list { overflow-y: auto; flex: 1; margin-bottom: 15px; }
.cat-header { background: #eee; padding: 8px; font-weight: bold; font-size: 12px; color: var(--secondary); margin-top: 10px; border-radius: 4px; }
.item-row { display: flex; justify-content: space-between; padding: 10px 5px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }

</style>
</head>
<body>

<section id="splash" onclick="showLogin()">
    <img src="logo.png" class="logo-anim" alt="DB Logo" onerror="this.src='https://via.placeholder.com/150/3e2723/ffd180?text=DEJA+BREW'">
    <h1>DEJA BREW</h1>
    <p style="color:var(--accent); letter-spacing: 2px; font-size: 14px;">INVENTORY MANAGEMENT</p>
    <p style="font-size: 10px; opacity: 0.7; margin-top: 20px;">Touch to start</p>
</section>

<section id="login">
    <div class="login-box">
        <img src="logo.png" class="login-logo" onerror="this.src='https://via.placeholder.com/100?text=Logo'">
        <h2 style="color:var(--accent); margin:0; line-height: 1;">DEJA BREW</h2>
        <h4 style="color:white; margin: 5px 0 20px 0; font-weight: normal; opacity: 0.8;">Inventory Management</h4>
        
        <select id="role-select">
            <option value="" disabled selected>Select Position</option>
            <option value="Admin">Admin (Quita)</option>
            <option value="Manager">Manager (Omlang)</option>
            <option value="Chef">Chef (Briones)</option>
            <option value="Staff">Staff</option>
        </select>
        <input id="user-input" placeholder="Username" autocapitalize="off">
        <input id="pass-input" type="password" placeholder="Password">
        
        <button class="btn btn-accent" style="width:100%; margin-top:15px;" onclick="authenticate()">LOGIN</button>
        <p id="login-error" style="color: #ff5252; font-size: 12px; margin-top: 10px;"></p>
    </div>
</section>

<div id="main-app">
    <div class="top-nav">
        <div style="display:flex; align-items:center;">
            <i class="material-icons menu-trigger" onclick="toggleSidebar()" style="margin-right:10px; cursor:pointer;">menu</i>
            <span style="font-weight:bold; font-size: 14px;">DEJA BREW INVENTORY MANAGEMENT</span>
        </div>
        <div style="font-size:12px; display: none;">Session: <span id="timer">5:00</span></div> </div>

    <div class="sidebar" id="sidebar">
        <div class="profile-card">
            <img id="prof-pic" src="" style="width:70px; height:70px; border-radius:50%; border:2px solid var(--accent); object-fit:cover; background:white;" onerror="this.src='https://via.placeholder.com/70'">
            <h4 id="prof-name" style="margin:10px 0 5px 0;">User</h4>
            <span id="prof-role" class="badge" style="background:var(--accent); color:var(--primary);">Role</span>
        </div>

        <div class="nav-item active" onclick="nav('dashboard')">
            <i class="material-icons">dashboard</i> Dashboard
        </div>
        <div class="nav-item" onclick="nav('inventory')">
            <i class="material-icons">inventory</i> Inventory
        </div>
        <div class="nav-item" onclick="nav('reports')">
            <i class="material-icons">assessment</i> Reports
        </div>
        <div class="nav-item" onclick="nav('history')">
            <i class="material-icons">history</i> Transactions
        </div>

        <button class="btn" style="background:#d32f2f; color:white; margin-top:auto; display:flex; align-items:center; justify-content:center; gap:10px;" onclick="logout()">
            <i class="material-icons">logout</i> Logout
        </button>
    </div>

    <div class="content-area">
        
        <div id="view-dashboard" class="view-section">
            <h2 style="margin-top:0;">Dashboard</h2>
            <p style="font-size:12px; color:#666;">Tap a box below to view details.</p>
            
            <div class="stats-grid">
                <div class="stat-box" style="border-color: var(--secondary);" onclick="openDrillDown('TOTAL')">
                    <h2 id="d-total">0</h2>
                    <span>TOTAL ITEMS</span>
                    <div style="font-size:10px; color:#aaa; margin-top:5px;">(Click to view)</div>
                </div>
                <div class="stat-box" style="border-color: #fbc02d;" onclick="openDrillDown('LOW')">
                    <h2 id="d-low">0</h2>
                    <span>LOW STOCK ALERTS</span>
                    <div style="font-size:10px; color:#aaa; margin-top:5px;">(Click to view)</div>
                </div>
                <div class="stat-box" style="border-color: #d32f2f;" onclick="openDrillDown('EXPIRE')">
                    <h2 id="d-expire">0</h2>
                    <span style="color:#d32f2f;">EXPIRING SOON</span>
                    <div style="font-size:10px; color:#aaa; margin-top:5px;">(Click to view)</div>
                </div>
            </div>

            <div class="flex-row" style="flex-wrap:wrap;">
                <div class="card" style="flex:1; min-width:300px;">
                    <h3 style="margin-top:0; border-bottom:2px solid #eee; padding-bottom:10px;">ðŸ”¥ Best Sellers (Trends)</h3>
                    <ul class="trend-list" id="trend-list">
                        <li style="color:#888;">No sales data yet...</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="view-inventory" class="view-section" style="display:none;">
            
            <div class="card">
                <h3 style="margin-top:0;">Stock Management</h3>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:10px;">
                    
                    <div>
                        <div style="display:flex; gap:5px;">
                            <select id="inv-cat" style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc;"></select>
                            <button onclick="addCustom('category')" class="btn btn-primary" style="padding:0 10px;">+</button>
                        </div>
                    </div>

                    <input id="inv-name" placeholder="Item Name" style="padding:10px; border-radius:6px; border:1px solid #ccc;">
                    
                    <div>
                        <div style="display:flex; gap:5px;">
                            <input id="inv-qty" type="number" placeholder="Qty" style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc;">
                            <select id="inv-unit" style="width:80px; padding:10px; border-radius:6px; border:1px solid #ccc;"></select>
                            <button onclick="addCustom('unit')" class="btn btn-primary" style="padding:0 10px;">+</button>
                        </div>
                    </div>

                    <div id="expiry-wrapper" style="display:none;">
                         <label style="font-size:10px; font-weight:bold;">Expiration Date:</label>
                         <input id="inv-expiry" type="date" style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc;">
                    </div>
                </div>

                <div class="flex-row" style="margin-top:15px;">
                    <button class="btn" style="flex:1; background:var(--success); color:white;" onclick="stockAction('IN')">STOCK IN</button>
                    <button class="btn" style="flex:1; background:var(--secondary); color:white;" onclick="stockAction('OUT')">STOCK OUT</button>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <b>Inventory List</b>
                    <input id="search-bar" onkeyup="renderInventory()" placeholder="Search..." style="padding:5px; border:1px solid #ccc; border-radius:4px; width: 120px;">
                </div>
                
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>ITEM</th>
                                <th>CAT</th>
                                <th>QTY</th>
                                <th>EXPIRY</th>
                                <th>ACT</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body"></tbody>
                    </table>
                </div>

                <div class="pagination">
                    <button class="btn btn-primary" onclick="changePage(-1)"><</button>
                    <span id="page-num">Page 1</span>
                    <button class="btn btn-primary" onclick="changePage(1)">></button>
                </div>
            </div>
        </div>

        <div id="view-reports" class="view-section" style="display:none;">
            <h2>Reports Center</h2>
            <div class="card">
                <h3>Export Data (Excel/CSV)</h3>
                
                <div style="margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:20px;">
                    <b>1. Low Stock Report</b><br>
                    <small>List of items below 5 quantity.</small><br>
                    <button class="btn btn-primary" style="margin-top:10px;" onclick="exportReport('LOW')">Download Low Stock</button>
                </div>

                <div style="margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:20px;">
                    <b>2. Weekly Stock Needs</b><br>
                    <small>Estimated stock needed based on recent sales.</small><br>
                    <button class="btn btn-primary" style="margin-top:10px;" onclick="exportReport('NEEDS')">Download Weekly Plan</button>
                </div>

                <div>
                    <b>3. Transaction Logs</b><br>
                    <div class="flex-row" style="margin-top:10px; max-width:400px;">
                        <input type="date" id="rep-start" style="padding:8px; border:1px solid #ccc;">
                        <input type="date" id="rep-end" style="padding:8px; border:1px solid #ccc;">
                    </div>
                    <button class="btn btn-primary" style="margin-top:10px;" onclick="exportReport('LOGS')">Download Logs</button>
                </div>
            </div>
        </div>

        <div id="view-history" class="view-section" style="display:none;">
            <div class="card">
                <div style="display:flex; justify-content:space-between;">
                    <h3>Transaction Log</h3>
                    <button id="clear-logs-btn" class="btn" style="background:#d32f2f; color:white; font-size:10px; display:none;" onclick="clearLogs()">CLEAR ALL</button>
                </div>
                <div style="overflow-x:auto;">
                    <table style="font-size:12px;">
                        <thead><tr><th>DATE</th><th>USER</th><th>ACTION</th><th>ITEM</th></tr></thead>
                        <tbody id="log-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="drill-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="drill-title" style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">Details</h3>
        
        <div id="drill-list-container" class="drill-list">
            </div>

        <div class="pagination" style="margin-top: auto; padding-top:10px; border-top:1px solid #eee;">
            <button class="btn btn-primary" onclick="changeDrillPage(-1)"><</button>
            <span id="drill-page-num" style="font-size:12px;">Page 1</span>
            <button class="btn btn-primary" onclick="changeDrillPage(1)">></button>
        </div>
        
        <button class="btn" style="width:100%; margin-top:10px; background:#ddd;" onclick="document.getElementById('drill-modal').style.display='none'">Close</button>
    </div>
</div>

<script>
/* --- CONFIG & DATA --- */
const accounts = {
    "quita": { pass: "Quita246", role: "Admin", name: "Quita", pic: "admin.png" },
    "omlang": { pass: "Omlang246", role: "Manager", name: "Omlang", pic: "manager.png" },
    "briones": { pass: "Briones246", role: "Chef", name: "Briones", pic: "chef.png" },
    "decastro": { pass: "Decastro246", role: "Staff", name: "Decastro", pic: "decastro.png" },
    "ewayan": { pass: "Ewayan246", role: "Staff", name: "Ewayan", pic: "ewayan.png" },
    "tan": { pass: "Tan246", role: "Staff", name: "Tan", pic: "tan.png" }
};

let db = JSON.parse(localStorage.getItem("db_inventory")) || {};
let logs = JSON.parse(localStorage.getItem("db_logs")) || [];
let categories = JSON.parse(localStorage.getItem("db_cats")) || ["Ingredients", "Machines", "Furniture", "Packaging"];
let units = JSON.parse(localStorage.getItem("db_units")) || ["kg", "pcs", "sack/s", "L", "pack"];

let currentUser = null;
let currentPage = 1;
const itemsPerPage = 8;
let sessionTimer;

// Drill Down State
let drillData = [];
let drillPage = 1;
const drillPerPage = 6;

/* --- INIT --- */
document.addEventListener("DOMContentLoaded", () => {
    setTimeout(() => {
        document.getElementById("splash").style.display = "none";
        document.getElementById("login").style.display = "flex";
    }, 2000);
    populateSelects();
});

function populateSelects() {
    const catSel = document.getElementById("inv-cat");
    const unitSel = document.getElementById("inv-unit");
    catSel.innerHTML = categories.map(c => `<option>${c}</option>`).join('');
    unitSel.innerHTML = units.map(u => `<option>${u}</option>`).join('');
}

/* --- AUTH --- */
function showLogin() { /* Helper */ }

function authenticate() {
    const role = document.getElementById("role-select").value;
    const u = document.getElementById("user-input").value.trim().toLowerCase();
    const p = document.getElementById("pass-input").value;

    if (accounts[u] && accounts[u].pass === p && accounts[u].role === role) {
        currentUser = accounts[u];
        document.getElementById("login").style.display = "none";
        document.getElementById("main-app").style.display = "flex";
        
        document.getElementById("prof-name").innerText = currentUser.name;
        document.getElementById("prof-role").innerText = currentUser.role;
        document.getElementById("prof-pic").src = currentUser.pic;
        if(currentUser.role === 'Admin') document.getElementById("clear-logs-btn").style.display = "block";
        
        startSession();
        nav('dashboard');
    } else {
        document.getElementById("login-error").innerText = "Invalid Login Details";
    }
}

function logout() { location.reload(); }

function startSession() {
    clearInterval(sessionTimer);
    let timeLeft = 300;
    sessionTimer = setInterval(() => {
        timeLeft--;
        if(timeLeft <= 0) logout();
    }, 1000);
}

/* --- NAVIGATION --- */
function nav(viewId) {
    document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.getElementById(`view-${viewId}`).style.display = 'block';
    
    // Highlight sidebar
    const navItems = document.querySelectorAll('.nav-item');
    if(viewId === 'dashboard') { navItems[0].classList.add('active'); renderDashboard(); }
    if(viewId === 'inventory') { navItems[1].classList.add('active'); renderInventory(); }
    if(viewId === 'reports') navItems[2].classList.add('active');
    if(viewId === 'history') { navItems[3].classList.add('active'); renderLogs(); }

    if(window.innerWidth < 800) toggleSidebar(); 
}

function toggleSidebar() { document.getElementById("sidebar").classList.toggle("active"); }

/* --- INVENTORY LOGIC --- */
function addCustom(type) {
    const val = prompt(`Enter new ${type}:`);
    if(val) {
        if(type === 'category') { categories.push(val); localStorage.setItem("db_cats", JSON.stringify(categories)); }
        if(type === 'unit') { units.push(val); localStorage.setItem("db_units", JSON.stringify(units)); }
        populateSelects();
    }
}

function stockAction(type) {
    if (type === 'IN') {
        const dateInput = document.getElementById("expiry-wrapper");
        if (dateInput.style.display === "none") {
            dateInput.style.display = "block";
            alert("Set expiration date (if any), then click STOCK IN again.");
            return;
        }
    }
    updateStock(type);
    document.getElementById("expiry-wrapper").style.display = "none";
}

function updateStock(type) {
    const name = document.getElementById("inv-name").value.trim().toUpperCase();
    const qty = parseFloat(document.getElementById("inv-qty").value);
    const cat = document.getElementById("inv-cat").value;
    const unit = document.getElementById("inv-unit").value;
    const expiry = document.getElementById("inv-expiry").value;

    if(!name || isNaN(qty) || qty <= 0) return alert("Invalid Name or Quantity");

    if(!db[name]) {
        db[name] = { qty: 0, cat: cat, unit: unit, expiry: '', lastUpdated: Date.now(), stockOutCount: 0 };
    }

    if(type === 'IN') {
        db[name].qty += qty;
        db[name].cat = cat; 
        db[name].unit = unit;
        if(expiry) db[name].expiry = expiry;
        db[name].lastUpdated = Date.now();
    } else {
        if(db[name].qty < qty) return alert("Insufficient Stock");
        db[name].qty -= qty;
        db[name].stockOutCount += qty;
    }

    localStorage.setItem("db_inventory", JSON.stringify(db));
    logTx(type, name, qty);
    
    document.getElementById("inv-name").value = "";
    document.getElementById("inv-qty").value = "";
    document.getElementById("inv-expiry").value = "";
    renderInventory();
    alert("Success!");
}

function deleteItem(name) {
    if(confirm("Delete item permanently?")) {
        delete db[name];
        localStorage.setItem("db_inventory", JSON.stringify(db));
        renderInventory();
    }
}

/* --- RENDER INVENTORY (Main List) --- */
function renderInventory() {
    const tbody = document.getElementById("inventory-table-body");
    tbody.innerHTML = "";
    const search = document.getElementById("search-bar").value.toLowerCase();

    let list = Object.entries(db).map(([k, v]) => ({name: k, ...v}));
    list.sort((a,b) => b.lastUpdated - a.lastUpdated); 

    list = list.filter(item => item.name.toLowerCase().includes(search) || item.cat.toLowerCase().includes(search));

    const totalPages = Math.ceil(list.length / itemsPerPage) || 1;
    if(currentPage > totalPages) currentPage = totalPages;
    const start = (currentPage - 1) * itemsPerPage;
    const pageItems = list.slice(start, start + itemsPerPage);

    document.getElementById("page-num").innerText = `Page ${currentPage} of ${totalPages}`;

    pageItems.forEach(item => {
        let expInfo = item.expiry ? `<br><small style="font-size:9px; color:#666;">${item.expiry}</small>` : '';
        tbody.innerHTML += `
        <tr>
            <td><b>${item.name}</b></td>
            <td>${item.cat}</td>
            <td style="color:${item.qty<=5?'red':'inherit'}">${item.qty} ${item.unit}</td>
            <td>${expInfo}</td>
            <td>${currentUser.role === 'Admin' ? `<button onclick="deleteItem('${item.name}')" style="background:#ff5252; color:white; border:none; padding:4px; border-radius:4px;">X</button>` : ''}</td>
        </tr>`;
    });
}
function changePage(dir) {
    if(dir === 1) currentPage++;
    else if (currentPage > 1) currentPage--;
    renderInventory();
}

/* --- DASHBOARD & DRILL DOWN LOGIC --- */
function renderDashboard() {
    let totalItems = 0, lowStock = 0, expiring = 0;
    let trendArr = [];
    const today = new Date();

    Object.entries(db).forEach(([name, item]) => {
        totalItems++;
        if(item.qty <= 5) lowStock++;
        if(item.expiry) {
            const diff = (new Date(item.expiry) - today) / (1000*60*60*24);
            if(diff <= 7) expiring++;
        }
        if(item.stockOutCount > 0) trendArr.push({name: name, count: item.stockOutCount});
    });

    document.getElementById("d-total").innerText = totalItems;
    document.getElementById("d-low").innerText = lowStock;
    document.getElementById("d-expire").innerText = expiring;

    trendArr.sort((a,b) => b.count - a.count);
    const trendList = document.getElementById("trend-list");
    trendList.innerHTML = "";
    trendArr.slice(0, 3).forEach((t, i) => {
        trendList.innerHTML += `<li><span>${i+1}. ${t.name}</span> <span class="badge" style="background:var(--success)">${t.count} Sold</span></li>`;
    });
}

// Open the Modal and prepare data
function openDrillDown(type) {
    const today = new Date();
    drillData = []; // Clear old data
    drillPage = 1;
    
    document.getElementById("drill-modal").style.display = "flex";
    
    let rawItems = [];
    let title = "";

    // 1. Filter Items
    Object.entries(db).forEach(([name, item]) => {
        let include = false;
        let extraInfo = `${item.qty} ${item.unit}`;

        if(type === 'TOTAL') {
            title = "Total Inventory";
            include = true;
        } else if (type === 'LOW') {
            title = "Low Stock Alerts";
            if(item.qty <= 5) {
                include = true;
                extraInfo = `<span style="color:red; font-weight:bold;">${item.qty} ${item.unit}</span>`;
            }
        } else if (type === 'EXPIRE') {
            title = "Expiring Soon (7 Days)";
            if(item.expiry) {
                const diff = (new Date(item.expiry) - today) / (1000*60*60*24);
                if(diff <= 7) {
                    include = true;
                    extraInfo = `Exp: ${item.expiry}`;
                }
            }
        }

        if(include) {
            rawItems.push({ name: name, cat: item.cat, info: extraInfo });
        }
    });

    document.getElementById("drill-title").innerText = title;

    // 2. Sort by Category
    rawItems.sort((a, b) => a.cat.localeCompare(b.cat));

    // 3. Build Flattened List with Headers
    let currentCat = "";
    rawItems.forEach(item => {
        if(item.cat !== currentCat) {
            drillData.push({ type: 'header', text: item.cat });
            currentCat = item.cat;
        }
        drillData.push({ type: 'row', name: item.name, info: item.info });
    });

    if(drillData.length === 0) drillData.push({ type: 'msg', text: "No items found." });

    renderDrillDown();
}

// Render the specific page of the drill down list
function renderDrillDown() {
    const container = document.getElementById("drill-list-container");
    container.innerHTML = "";

    const totalPages = Math.ceil(drillData.length / drillPerPage) || 1;
    if(drillPage > totalPages) drillPage = totalPages;
    const start = (drillPage - 1) * drillPerPage;
    const end = start + drillPerPage;
    const itemsToShow = drillData.slice(start, end);

    document.getElementById("drill-page-num").innerText = `Page ${drillPage} of ${totalPages}`;

    itemsToShow.forEach(item => {
        if(item.type === 'header') {
            container.innerHTML += `<div class="cat-header">${item.text}</div>`;
        } else if (item.type === 'row') {
            container.innerHTML += `
            <div class="item-row">
                <span>${item.name}</span>
                <span>${item.info}</span>
            </div>`;
        } else {
            container.innerHTML += `<div style="padding:20px; text-align:center; color:#999;">${item.text}</div>`;
        }
    });
}

function changeDrillPage(dir) {
    const totalPages = Math.ceil(drillData.length / drillPerPage) || 1;
    if(dir === 1 && drillPage < totalPages) drillPage++;
    else if (dir === -1 && drillPage > 1) drillPage--;
    renderDrillDown();
}

/* --- REPORTS & LOGS --- */
function logTx(action, item, qty) {
    logs.unshift({ date: new Date().toLocaleString(), user: currentUser.name, action: action, item: item, qty: qty });
    if(logs.length > 100) logs.pop();
    localStorage.setItem("db_logs", JSON.stringify(logs));
}

function renderLogs() {
    document.getElementById("log-table-body").innerHTML = logs.map(l => `
        <tr><td>${l.date}</td><td>${l.user}</td><td style="color:${l.action==='IN'?'green':'red'}">${l.action}</td><td>${l.item} (${l.qty})</td></tr>
    `).join('');
}

function clearLogs() {
    if(confirm("Clear Audit Trail?")) { logs = []; localStorage.setItem("db_logs", JSON.stringify(logs)); renderLogs(); }
}

function exportReport(type) {
    let csv = "data:text/csv;charset=utf-8,";
    if(type === 'LOW') {
        csv += "Category,Item,Qty,Unit\n";
        Object.entries(db).forEach(([k,v]) => { if(v.qty<=5) csv += `${v.cat},${k},${v.qty},${v.unit}\n`; });
    } else if (type === 'NEEDS') {
        csv += "Item,Sold,Estimated Need\n";
        Object.entries(db).forEach(([k,v]) => { csv += `${k},${v.stockOutCount},${v.stockOutCount}\n`; });
    } else if (type === 'LOGS') {
        csv += "Date,User,Action,Item,Qty\n";
        logs.forEach(l => csv += `${l.date},${l.user},${l.action},${l.item},${l.qty}\n`);
    }
    const link = document.createElement("a");
    link.href = encodeURI(csv);
    link.download = "report.csv";
    link.click();
}
</script>
</body>
</html>